<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fuel Blending Lab (Mass %) ‚Äì SAF Blend-Limit Check</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --card2:#0f1726;
      --text:#e8eefc;
      --muted:#a9b6d6;
      --line:rgba(255,255,255,.10);
      --accent:#62a8ff;
      --ok:#4ade80;
      --bad:#fb7185;
      --warn:#fbbf24;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg, #081022 0%, #060b16 100%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    .topbar{
      display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{font-size:20px;font-weight:800;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px;line-height:1.35;max-width:760px}
    .meta{color:var(--muted);font-size:12px;text-align:right}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .meta{text-align:left}
    }
    .panel{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .panelHead b{font-size:13px}
    .panelBody{padding:14px 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:240px}
    label{display:flex;justify-content:space-between;gap:8px;align-items:center;color:var(--muted);font-size:12px;margin:10px 0 6px}
    .inp, select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    .inp:focus, select:focus{border-color:rgba(98,168,255,.6);box-shadow:0 0 0 3px rgba(98,168,255,.15)}
    .hint{color:var(--muted);font-size:12px;line-height:1.35;margin-top:8px}
    .small{font-size:12px;color:var(--muted)}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background:rgba(98,168,255,.10);border:1px solid rgba(98,168,255,.25);
      color:var(--text);font-size:12px;
    }
    .divider{height:1px;background:var(--line);margin:14px 0}
    .sliderRow{display:grid;grid-template-columns:120px 1fr 120px;gap:10px;align-items:center;margin-top:10px}
    .pill{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      border-radius:999px;padding:7px 10px;
      font-size:12px;color:var(--text);text-align:center;
    }
    input[type="range"]{width:100%}
    .cardsGrid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 520px){
      .cardsGrid{grid-template-columns:1fr}
    }
    .outCard{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .outTitle{
      display:flex;align-items:center;gap:8px;
      font-size:12px;color:var(--muted);margin-bottom:6px
    }
    .outValue{font-size:18px;font-weight:800;letter-spacing:.2px}
    .outSub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.3}
    .bar{
      height:10px;border-radius:999px;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;margin-top:10px;
    }
    .bar > i{display:block;height:100%;width:50%;background:linear-gradient(90deg, rgba(98,168,255,.35), rgba(98,168,255,.85))}
    .bar.gold > i{background:linear-gradient(90deg, rgba(251,191,36,.35), rgba(251,191,36,.9))}
    .bar.ok > i{background:linear-gradient(90deg, rgba(74,222,128,.35), rgba(74,222,128,.85))}
    .bar.bad > i{background:linear-gradient(90deg, rgba(251,113,133,.35), rgba(251,113,133,.85))}
    .tag{
      position:absolute;top:10px;right:10px;
      font-size:11px;color:var(--muted)
    }

    /* Responsive "Key outputs (columns)" */
    .kpiGrid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 820px){ .kpiGrid{grid-template-columns:repeat(2, minmax(0,1fr));} }
    @media (max-width: 420px){ .kpiGrid{grid-template-columns:1fr;} }
    .kpi{
      background:rgba(0,0,0,.16);
      border:1px solid var(--line);
      border-radius:14px;padding:10px;
      min-width:0;
    }
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:16px;font-weight:800;margin-top:6px}
    .kpi .u{font-size:12px;color:var(--muted);margin-top:2px}

    /* Horizontal "formula bars" */
    .formulaBars{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .fbar{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
    }
    .fleft{min-width:0}
    .fleft .k{font-size:12px;color:var(--muted);margin-bottom:4px}
    .fleft .t{
      font-size:12px;color:var(--text);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .fright{
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }

    /* Tooltips */
    .tipBtn{
      width:18px;height:18px;border-radius:999px;
      display:inline-grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      cursor:help;
      user-select:none;
    }
    .tip{
      position:absolute;
      left:12px; right:12px;
      top:40px;
      background:rgba(10,16,30,.98);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 10px;
      color:var(--text);
      font-size:12px;
      line-height:1.35;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      display:none;
      z-index:20;
    }
    .outCard.showTip .tip{display:block}
    .tip b{display:block;margin-bottom:6px}
    .tip code{
      display:block;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      padding:8px;border-radius:10px;margin-top:6px;
      overflow:auto;
      white-space:pre-wrap;
    }

    /* SAF compliance highlight */
    #safComplianceCard.pass{outline:2px solid rgba(74,222,128,.45)}
    #safComplianceCard.fail{outline:2px solid rgba(251,113,133,.50)}
    #safComplianceCard.warn{outline:2px solid rgba(251,191,36,.50)}
    .foot{
      margin-top:12px;color:var(--muted);font-size:12px;line-height:1.4
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border-radius:12px;border:1px solid var(--line);
      background:rgba(98,168,255,.12);
      color:var(--text);
      padding:9px 12px;
      font-size:12px;
      cursor:pointer;
    }
    .btn.secondary{background:rgba(255,255,255,.06)}
    .btn.danger{background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.22)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">Fuel Blending Lab (Mass %)</div>
        <div class="subtitle">
          Two-component blending by mass %. Live outputs: density, LHV, surrogate formula, stoichiometry,
          emissions indicators, and optional sizing. Includes SAF pathway blend-limit (vol%) screening check.
        </div>
      </div>
      <div class="meta">
        Basis: mass% (A + B = 100)<br/>
        Screening tool: trend-focused
      </div>
    </div>

    <div class="grid">
      <!-- INPUTS -->
      <div class="panel">
        <div class="panelHead">
          <b>Inputs</b>
          <span class="chip">Saved locally in this browser</span>
        </div>
        <div class="panelBody">
          <label>Search fuels (key or name)</label>
          <input id="search" class="inp" placeholder="Type to filter dropdowns (e.g., HEFA, Jet-A, methane, ethanol‚Ä¶)" />

          <div class="row">
            <div class="col">
              <label>Fuel A</label>
              <select id="fuelA"></select>
            </div>
            <div class="col">
              <label>Fuel B</label>
              <select id="fuelB"></select>
            </div>
          </div>

          <div class="sliderRow">
            <div class="pill" id="pillA">A: 50%</div>
            <input id="blend" type="range" min="0" max="100" value="50" />
            <div class="pill" id="pillB">B: 50%</div>
          </div>

          <label>Optional blend name</label>
          <input id="blendName" class="inp" placeholder="Leave blank for auto-name" />

          <div class="divider"></div>

          <div class="row" style="align-items:flex-end">
            <div class="col">
              <label>Actual AFR (kg air / kg fuel) <span class="small">slider</span></label>
              <input id="afrAct" type="range" min="8" max="30" step="0.1" value="18" />
              <div class="small">Value: <b id="afrActVal">18.0</b></div>
            </div>
            <div class="col">
              <label>Target thermal power QÃá (MW‚Çú‚Çï) <span class="small">slider</span></label>
              <input id="Qth" type="range" min="0" max="50" step="0.5" value="10" />
              <div class="small">Value: <b id="QthVal">10.0</b></div>
            </div>
          </div>

          <div class="hint">
            If AFR<sub>act</sub> is set, the tool computes equivalence ratio œï and excess air Œª.
            If QÃá is set, the tool computes fuel/air mass flow rates.
          </div>

          <div class="divider"></div>

          <!-- SAF compliance UI -->
          <div class="panel" style="background:transparent;border:none;box-shadow:none">
            <div class="row" style="gap:12px;align-items:flex-end">
              <div class="col">
                <label>Compliance mode</label>
                <select id="compMode" class="inp">
                  <option value="none">None</option>
                  <option value="AisSAF">Treat Fuel A as SAF blendstock + Fuel B as Jet-A</option>
                  <option value="BisSAF">Treat Fuel B as SAF blendstock + Fuel A as Jet-A</option>
                </select>
              </div>
              <div class="col">
                <label>SAF pathway (ASTM D7566 annex)</label>
                <select id="safPathway" class="inp"></select>
              </div>
            </div>
            <div class="hint">
              This checks ONLY the maximum allowed SAF blending limit (vol%) by pathway. Final blended fuel must still meet ASTM D1655 properties.
            </div>
          </div>

          <div class="divider"></div>

          <!-- Add/Edit fuel -->
          <b style="font-size:13px">Edit / Add Fuel</b>
          <div class="row">
            <div class="col">
              <label>Fuel key to edit</label>
              <select id="editKey"></select>
            </div>
            <div class="col">
              <label>Fuel name</label>
              <input id="editName" class="inp" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>xC (C‚ÇìH·µßOùìè)</label>
              <input id="editX" class="inp" type="number" step="0.001" />
            </div>
            <div class="col">
              <label>yH</label>
              <input id="editY" class="inp" type="number" step="0.001" />
            </div>
            <div class="col">
              <label>zO</label>
              <input id="editZ" class="inp" type="number" step="0.001" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Density œÅ (kg/m¬≥)</label>
              <input id="editRho" class="inp" type="number" step="0.1" />
            </div>
            <div class="col">
              <label>LHV (MJ/kg)</label>
              <input id="editLHV" class="inp" type="number" step="0.01" />
            </div>
          </div>

          <div class="btnRow">
            <button class="btn" id="btnSaveFuel">Save / Update Fuel</button>
            <button class="btn secondary" id="btnNewFuel">Create New Fuel</button>
            <button class="btn danger" id="btnResetLib">Reset Library</button>
          </div>

          <div class="foot">
            Fuel library is stored in your browser (localStorage). ‚ÄúReset Library‚Äù restores defaults.
          </div>
        </div>
      </div>

      <!-- OUTPUTS -->
      <div class="panel">
        <div class="panelHead">
          <b>Outputs (Visual)</b>
          <span class="chip" id="blendChip">‚Äî</span>
        </div>
        <div class="panelBody">

          <div class="cardsGrid">
            <!-- LHV -->
            <div class="outCard" id="cardLHV">
              <div class="outTitle">
                LHV
                <span class="tipBtn" data-tip="LHV">i</span>
              </div>
              <div class="outValue" id="outLHV">‚Äî</div>
              <div class="bar"><i id="barLHV"></i></div>
              <div class="outSub">MJ/kg</div>
              <div class="tip" id="tipLHV"></div>
            </div>

            <!-- Density -->
            <div class="outCard" id="cardRho">
              <div class="outTitle">
                Density
                <span class="tipBtn" data-tip="RHO">i</span>
              </div>
              <div class="outValue" id="outRho">‚Äî</div>
              <div class="bar"><i id="barRho"></i></div>
              <div class="outSub">kg/m¬≥</div>
              <div class="tip" id="tipRHO"></div>
            </div>

            <!-- AFRst -->
            <div class="outCard" id="cardAFRst">
              <div class="outTitle">
                AFR<sub>st</sub>
                <span class="tipBtn" data-tip="AFRST">i</span>
              </div>
              <div class="outValue" id="outAFRst">‚Äî</div>
              <div class="bar"><i id="barAFRst"></i></div>
              <div class="outSub">kg air / kg fuel</div>
              <div class="tip" id="tipAFRST"></div>
            </div>

            <!-- phi -->
            <div class="outCard" id="cardPhi">
              <div class="outTitle">
                œï (needs AFR<sub>act</sub>)
                <span class="tipBtn" data-tip="PHI">i</span>
              </div>
              <div class="outValue" id="outPhi">‚Äî</div>
              <div class="bar"><i id="barPhi"></i></div>
              <div class="outSub">dimensionless</div>
              <div class="tip" id="tipPHI"></div>
            </div>

            <!-- SAF compliance -->
            <div class="outCard" id="safComplianceCard">
              <div class="outTitle">
                SAF blend-limit check
                <span class="tipBtn" data-tip="SAF">i</span>
              </div>
              <div class="outValue" id="safComplianceValue">‚Äî</div>
              <div class="bar gold"><i id="barSAF"></i></div>
              <div class="outSub" id="safComplianceSub">Select mode + pathway</div>
              <div class="tip" id="tipSAF"></div>
            </div>

            <!-- CO2 per energy -->
            <div class="outCard" id="cardCO2kWh">
              <div class="outTitle">
                CO‚ÇÇ per energy
                <span class="tipBtn" data-tip="CO2KWH">i</span>
              </div>
              <div class="outValue" id="outCO2kWh">‚Äî</div>
              <div class="bar"><i id="barCO2kWh"></i></div>
              <div class="outSub">g/kWh‚Çú‚Çï</div>
              <div class="tip" id="tipCO2KWH"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="panel" style="background:transparent;border:none;box-shadow:none">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
              <b style="font-size:13px">Key outputs (columns)</b>
              <span class="small">scaled to typical ranges</span>
            </div>

            <div class="kpiGrid">
              <div class="kpi">
                <div class="k">LHV volumetric</div>
                <div class="v" id="kpiLHVv">‚Äî</div>
                <div class="u">MJ/L</div>
              </div>
              <div class="kpi">
                <div class="k">CO‚ÇÇ intensity</div>
                <div class="v" id="kpiCO2kgkg">‚Äî</div>
                <div class="u">kg/kg fuel</div>
              </div>
              <div class="kpi">
                <div class="k">H‚ÇÇO intensity</div>
                <div class="v" id="kpiH2Okgkg">‚Äî</div>
                <div class="u">kg/kg fuel</div>
              </div>
              <div class="kpi">
                <div class="k">q per kg air</div>
                <div class="v" id="kpiQair">‚Äî</div>
                <div class="u">MJ/kg air</div>
              </div>
            </div>

            <div class="formulaBars">
              <div class="fbar">
                <div class="fleft">
                  <div class="k">Surrogate formula</div>
                  <div class="t" id="txtFormula">‚Äî</div>
                </div>
                <div class="fright" id="txtMW">MW: ‚Äî g/mol</div>
              </div>

              <div class="fbar">
                <div class="fleft">
                  <div class="k">Stoichiometry</div>
                  <div class="t" id="txtStoich">‚Äî</div>
                </div>
                <div class="fright" id="txtLambda">Œª: ‚Äî</div>
              </div>

              <div class="fbar">
                <div class="fleft">
                  <div class="k">Sizing (if QÃá & AFRact set)</div>
                  <div class="t" id="txtSizing">‚Äî</div>
                </div>
                <div class="fright" id="txtFlows">·πÅf: ‚Äî  |  ·πÅa: ‚Äî</div>
              </div>
            </div>

            <div class="foot">
              Disclaimer: Screening-level engineering calculator based on surrogate composition and idealized mixing.
              Not for certification or compliance decisions.
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Default fuel library
   ========================= */
const DEFAULT_FUELS = {
  // Conventional
  "JET_A":        { name:"Jet-A / Jet-A1 (rep)", x:11.0, y:21.0, z:0.0, rho:804,  lhv:43.1 },
  "JP8":          { name:"JP-8 (rep)",          x:11.1, y:21.5, z:0.0, rho:805,  lhv:43.0 },
  "E_KERO":       { name:"e-Kerosene (rep)",    x:11.0, y:22.0, z:0.0, rho:780,  lhv:43.5 },

  // SAF representative blendstocks (surrogate-style)
  "HEFA_SPK":     { name:"HEFA-SPK (rep)",      x:12.0, y:26.0, z:0.0, rho:775,  lhv:44.0 },
  "FT_SPK":       { name:"FT-SPK (rep)",        x:12.3, y:26.6, z:0.0, rho:760,  lhv:44.2 },
  "ATJ_SPK":      { name:"ATJ-SPK (rep)",       x:12.0, y:26.0, z:0.0, rho:770,  lhv:43.8 },
  "SIP":          { name:"SIP (rep)",           x:10.0, y:18.0, z:0.0, rho:760,  lhv:43.0 },
  "FT_SKA":       { name:"FT-SKA (rep)",        x:12.0, y:24.0, z:0.0, rho:780,  lhv:43.6 },
  "CHJ":          { name:"CHJ (rep)",           x:12.0, y:24.0, z:0.0, rho:790,  lhv:43.4 },
  "HC_HEFA":      { name:"HC-HEFA-SPK (rep)",   x:12.0, y:24.0, z:0.0, rho:770,  lhv:43.7 },

  // Oxygenates & light fuels (for testing)
  "ETHANOL":      { name:"Ethanol",             x:2.0,  y:6.0,  z:1.0, rho:789,  lhv:26.8 },
  "METHANOL":     { name:"Methanol",            x:1.0,  y:4.0,  z:1.0, rho:792,  lhv:19.9 },
  "CH4_LIQ":      { name:"Liquid CH‚ÇÑ (LCH‚ÇÑ)",   x:1.0,  y:4.0,  z:0.0, rho:422,  lhv:50.0 },
  "H2_LIQ":       { name:"Liquid H‚ÇÇ (LH‚ÇÇ)",     x:0.0,  y:2.0,  z:0.0, rho:71,   lhv:120.0 }
};

/* =========================
   SAF pathways (blend limits in vol%)
   Screening only.
   ========================= */
const SAF_PATHWAYS = {
  "FT-SPK (Annex A1)":        { maxVolPct: 50, ref: "ASTM D7566 Annex A1" },
  "HEFA-SPK (Annex A2)":      { maxVolPct: 50, ref: "ASTM D7566 Annex A2" },
  "SIP (Annex A3)":           { maxVolPct: 10, ref: "ASTM D7566 Annex A3" },
  "FT-SKA (Annex A4)":        { maxVolPct: 50, ref: "ASTM D7566 Annex A4" },
  "ATJ-SPK (Annex A5)":       { maxVolPct: 50, ref: "ASTM D7566 Annex A5" },
  "CHJ (Annex A6)":           { maxVolPct: 50, ref: "ASTM D7566 Annex A6" },
  "HC-HEFA-SPK (Annex A7)":   { maxVolPct: 10, ref: "ASTM D7566 Annex A7" },
  "ATJ-SKA (Annex A8)":       { maxVolPct: 50, ref: "ASTM D7566 Annex A8" }
};

/* =========================
   Persistence
   ========================= */
const LS_KEY = "fuelsim_library_v2";

function loadLibrary(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(DEFAULT_FUELS);
    const obj = JSON.parse(raw);
    // basic validation
    if(!obj || typeof obj !== "object") return structuredClone(DEFAULT_FUELS);
    return obj;
  }catch(e){
    return structuredClone(DEFAULT_FUELS);
  }
}
function saveLibrary(lib){
  localStorage.setItem(LS_KEY, JSON.stringify(lib));
}

/* =========================
   Helpers
   ========================= */
function fmt(x, d=2){
  if(!isFinite(x)) return "‚Äî";
  return Number(x).toFixed(d);
}
function clamp01(p){ return Math.max(0, Math.min(1, p)); }
function scaleToBar(value, vmin, vmax){
  if(!isFinite(value) || vmax<=vmin) return 0;
  return clamp01((value - vmin)/(vmax - vmin));
}
function el(id){ return document.getElementById(id); }

function volFracFromMass(wA, rhoA, wB, rhoB){
  const vA = wA / rhoA;
  const vB = wB / rhoB;
  const vTot = vA + vB;
  return vTot > 0 ? (vA / vTot) : 0;
}

/* =========================
   Core calculations
   ========================= */
const MW = { C:12.011, H:1.008, O:15.999, O2:31.998, CO2:44.01, H2O:18.015 };
const YO2_AIR = 0.232;

function recalc(state){
  // Blend properties
  const wA = state.wA, wB = 1 - wA;

  const LHV = wA*state.A.lhv + wB*state.B.lhv;
  const rho = 1 / (wA/state.A.rho + wB/state.B.rho);

  const x = wA*state.A.x + wB*state.B.x;
  const y = wA*state.A.y + wB*state.B.y;
  const z = wA*state.A.z + wB*state.B.z;

  const MWfuel = MW.C*x + MW.H*y + MW.O*z; // g/mol
  const nuO2 = x + y/4 - z/2;              // mol O2/mol fuel

  const AFRst = (nuO2 * MW.O2) / (MWfuel * YO2_AIR); // kg air/kg fuel (g cancels)
  const afrAct = state.afrAct;
  const phi = (afrAct>0) ? (AFRst/afrAct) : NaN;
  const lambda = (isFinite(phi) && phi>0) ? (1/phi) : NaN;

  const CO2kgkg = (x*MW.CO2) / MWfuel;
  const H2Okgkg = ((y/2)*MW.H2O) / MWfuel;

  const CO2gkWh = (CO2kgkg / LHV) * 3.6 * 1000;

  const LHVv = (LHV * rho) / 1000; // MJ/L
  const qAir = (afrAct>0) ? (LHV/afrAct) : NaN;

  // Sizing
  const Qth = state.Qth; // MW = MJ/s
  const mdotF = (Qth>0) ? (Qth / LHV) : NaN; // kg/s
  const mdotA = (isFinite(mdotF) && afrAct>0) ? (afrAct * mdotF) : NaN;

  // SAF compliance (blend-limit in vol%)
  const comp = evaluateBlendLimitCompliance({wA, wB, rhoA:state.A.rho, rhoB:state.B.rho});

  return { wA,wB,LHV,rho,x,y,z,MWfuel,nuO2,AFRst,phi,lambda,CO2kgkg,H2Okgkg,CO2gkWh,LHVv,qAir,Qth,afrAct,mdotF,mdotA,comp };
}

function evaluateBlendLimitCompliance(s){
  const mode = el("compMode").value;
  const pathwayKey = el("safPathway").value;
  if(mode === "none") return { enabled:false };

  const path = SAF_PATHWAYS[pathwayKey];
  if(!path) return { enabled:false };

  const vA = volFracFromMass(s.wA, s.rhoA, s.wB, s.rhoB);
  const vB = 1 - vA;

  const safVolPct = (mode === "AisSAF" ? vA : vB) * 100;
  const pass = safVolPct <= path.maxVolPct + 1e-9;

  return {
    enabled:true,
    pathway: pathwayKey,
    maxAllowedVolPct: path.maxVolPct,
    safVolPct,
    pass,
    note: path.ref
  };
}

/* =========================
   Tooltips content (brief + formula)
   ========================= */
const TIPS = {
  LHV: {
    title: "Lower Heating Value (LHV)",
    text: "Energy released per kg of fuel (excluding latent heat of water). Blend is mass-weighted.",
    formula: "LHV_blend = wA¬∑LHV_A + wB¬∑LHV_B"
  },
  RHO: {
    title: "Blend density œÅ",
    text: "Estimated using specific-volume (additive volume) rule (screening approximation).",
    formula: "1/œÅ_blend = wA/œÅ_A + wB/œÅ_B"
  },
  AFRST: {
    title: "Stoichiometric AFR (AFRst)",
    text: "Air needed for complete combustion per kg fuel, based on surrogate CxHyOz and dry-air oxygen mass fraction.",
    formula: "ŒΩO2 = x + y/4 ‚àí z/2\nAFRst = (ŒΩO2¬∑MW_O2)/(MW_fuel¬∑Y_O2,air),  Y_O2,air=0.232"
  },
  PHI: {
    title: "Equivalence ratio (œï)",
    text: "œï > 1 is fuel-rich; œï < 1 is lean. Requires user input AFRact.",
    formula: "œï = AFRst / AFRact\nŒª = 1/œï"
  },
  CO2KWH: {
    title: "CO‚ÇÇ per thermal energy (LHV basis)",
    text: "Complete-combustion CO‚ÇÇ intensity per delivered thermal energy.",
    formula: "(gCO2/kWh_th) = (kgCO2/kgfuel)/LHV ¬∑ 3.6 ¬∑ 1000"
  },
  SAF: {
    title: "SAF blend-limit (vol%) screening",
    text: "Computes SAF volume fraction from mass% using densities and checks pathway max vol% limit. This does NOT certify ASTM compliance.",
    formula: "vA = (wA/œÅA) / (wA/œÅA + wB/œÅB)\nSAF vol% = 100¬∑vSAF\nPASS if SAF vol% ‚â§ pathway limit"
  }
};

function setTip(cardId, tipKey){
  const card = el(cardId);
  const tip = card.querySelector(".tip");
  const t = TIPS[tipKey];
  tip.innerHTML = `<b>${t.title}</b>${t.text}<code>${t.formula}</code>`;
}

/* =========================
   UI Wiring
   ========================= */
let LIB = loadLibrary();

function fuelsAsArray(){
  return Object.entries(LIB).map(([key, f]) => ({ key, ...f }));
}

function populateSelects(){
  const list = fuelsAsArray().sort((a,b)=>a.name.localeCompare(b.name));
  const sA = el("fuelA");
  const sB = el("fuelB");
  const sE = el("editKey");

  const filter = (el("search").value || "").trim().toLowerCase();

  function matches(f){
    if(!filter) return true;
    return f.key.toLowerCase().includes(filter) || f.name.toLowerCase().includes(filter);
  }

  const options = list.filter(matches).map(f => `<option value="${f.key}">${f.name}</option>`).join("");

  sA.innerHTML = options;
  sB.innerHTML = options;
  sE.innerHTML = list.map(f => `<option value="${f.key}">${f.name}</option>`).join("");

  // keep previous selections if still available
  const keepA = sA.dataset.keep || "HEFA_SPK";
  const keepB = sB.dataset.keep || "JET_A";
  if([...sA.options].some(o=>o.value===keepA)) sA.value = keepA;
  if([...sB.options].some(o=>o.value===keepB)) sB.value = keepB;

  // keep edit selection
  const keepE = sE.dataset.keep || keepA;
  if([...sE.options].some(o=>o.value===keepE)) sE.value = keepE;

  loadEditFields();
  update();
}

function initPathwayDropdown(){
  const sel = el("safPathway");
  sel.innerHTML = Object.keys(SAF_PATHWAYS)
    .map(k => `<option value="${k}">${k} (max ${SAF_PATHWAYS[k].maxVolPct}% v/v)</option>`)
    .join("");
  sel.value = Object.keys(SAF_PATHWAYS)[0];
}

function loadEditFields(){
  const key = el("editKey").value;
  const f = LIB[key];
  if(!f) return;

  el("editName").value = f.name ?? "";
  el("editX").value = f.x ?? 0;
  el("editY").value = f.y ?? 0;
  el("editZ").value = f.z ?? 0;
  el("editRho").value = f.rho ?? 0;
  el("editLHV").value = f.lhv ?? 0;
}

function safeNumber(v, fallback=0){
  const n = Number(v);
  return isFinite(n) ? n : fallback;
}

function update(){
  const keyA = el("fuelA").value;
  const keyB = el("fuelB").value;

  el("fuelA").dataset.keep = keyA;
  el("fuelB").dataset.keep = keyB;
  el("editKey").dataset.keep = el("editKey").value;

  const wA_pct = Number(el("blend").value);
  const wA = wA_pct/100;

  el("pillA").textContent = `A: ${wA_pct}%`;
  el("pillB").textContent = `B: ${100-wA_pct}%`;

  const afrAct = safeNumber(el("afrAct").value, 0);
  const Qth = safeNumber(el("Qth").value, 0);
  el("afrActVal").textContent = afrAct.toFixed(1);
  el("QthVal").textContent = Qth.toFixed(1);

  const A = LIB[keyA];
  const B = LIB[keyB];

  const autoName = `${A?.name ?? keyA} + ${B?.name ?? keyB} (${wA_pct}% / ${100-wA_pct}%)`;
  const blendName = (el("blendName").value || "").trim() || autoName;
  el("blendChip").textContent = blendName;

  const state = { A, B, wA, afrAct, Qth };
  const r = recalc(state);

  // Output cards values
  el("outLHV").textContent = `${fmt(r.LHV,2)}`;
  el("outRho").textContent = `${fmt(r.rho,1)}`;
  el("outAFRst").textContent = `${fmt(r.AFRst,2)}`;
  el("outPhi").textContent = isFinite(r.phi) ? `${fmt(r.phi,3)}` : "‚Äî";
  el("outCO2kWh").textContent = `${fmt(r.CO2gkWh,1)}`;

  // Bars scaling (typical ranges)
  el("barLHV").style.width = `${scaleToBar(r.LHV, 20, 50)*100}%`;
  el("barRho").style.width = `${scaleToBar(r.rho, 650, 900)*100}%`;
  el("barAFRst").style.width = `${scaleToBar(r.AFRst, 5, 25)*100}%`;
  el("barPhi").style.width = `${scaleToBar(r.phi, 0.2, 2.0)*100}%`;
  el("barCO2kWh").style.width = `${scaleToBar(r.CO2gkWh, 150, 350)*100}%`;

  // KPI columns
  el("kpiLHVv").textContent = `${fmt(r.LHVv,2)}`;
  el("kpiCO2kgkg").textContent = `${fmt(r.CO2kgkg,3)}`;
  el("kpiH2Okgkg").textContent = `${fmt(r.H2Okgkg,3)}`;
  el("kpiQair").textContent = isFinite(r.qAir) ? `${fmt(r.qAir,3)}` : "‚Äî";

  // Horizontal formula bars
  el("txtFormula").textContent = `C${fmt(r.x,3)}H${fmt(r.y,3)}O${fmt(r.z,3)}`;
  el("txtMW").textContent = `MW: ${fmt(r.MWfuel,2)} g/mol`;

  el("txtStoich").textContent =
    `ŒΩO‚ÇÇ: ${fmt(r.nuO2,4)} mol/mol | AFRst: ${fmt(r.AFRst,3)} kg/kg | œï: ${isFinite(r.phi)?fmt(r.phi,3):"‚Äî"}`;
  el("txtLambda").textContent = `Œª: ${isFinite(r.lambda)?fmt(r.lambda,3):"‚Äî"}`;

  const sizingTxt = (r.Qth>0)
    ? `QÃá: ${fmt(r.Qth,1)} MWth | LHV: ${fmt(r.LHV,2)} MJ/kg`
    : "Provide QÃá to compute sizing";
  el("txtSizing").textContent = sizingTxt;

  el("txtFlows").textContent =
    `·πÅf: ${isFinite(r.mdotF)?fmt(r.mdotF,4)+" kg/s":"‚Äî"}  |  ·πÅa: ${isFinite(r.mdotA)?fmt(r.mdotA,4)+" kg/s":"‚Äî"}`;

  // SAF compliance card
  const card = el("safComplianceCard");
  const v = el("safComplianceValue");
  const sub = el("safComplianceSub");

  card.classList.remove("pass","fail","warn");

  if(!r.comp.enabled){
    v.textContent = "‚Äî";
    sub.textContent = "Blend-limit check disabled";
    el("barSAF").style.width = "0%";
  } else {
    const safVol = r.comp.safVolPct;
    const max = r.comp.maxAllowedVolPct;

    const p = clamp01(safVol / Math.max(1e-9, max));
    el("barSAF").style.width = `${p*100}%`;

    if(r.comp.pass){
      v.textContent = "PASS";
      sub.textContent = `SAF = ${safVol.toFixed(2)}% v/v ‚â§ ${max}% v/v ‚Ä¢ ${r.comp.note}`;
      card.classList.add("pass");
    } else {
      v.textContent = "FAIL";
      sub.textContent = `SAF = ${safVol.toFixed(2)}% v/v > ${max}% v/v ‚Ä¢ ${r.comp.note}`;
      card.classList.add("fail");
    }
  }
}

/* =========================
   Tooltip behavior
   ========================= */
function initTooltips(){
  setTip("cardLHV","LHV");
  setTip("cardRho","RHO");
  setTip("cardAFRst","AFRST");
  setTip("cardPhi","PHI");
  setTip("cardCO2kWh","CO2KWH");
  setTip("safComplianceCard","SAF");

  document.querySelectorAll(".tipBtn").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation();
      const card = btn.closest(".outCard");
      const isOpen = card.classList.contains("showTip");
      document.querySelectorAll(".outCard").forEach(c=>c.classList.remove("showTip"));
      if(!isOpen) card.classList.add("showTip");
    });
  });

  document.addEventListener("click", ()=>{
    document.querySelectorAll(".outCard").forEach(c=>c.classList.remove("showTip"));
  });
}

/* =========================
   Events
   ========================= */
function wire(){
  ["search","blend","blendName","fuelA","fuelB","afrAct","Qth","compMode","safPathway"]
    .forEach(id => el(id).addEventListener("input", ()=>{
      if(id==="search") populateSelects(); else update();
    }));

  el("editKey").addEventListener("change", loadEditFields);

  el("btnSaveFuel").addEventListener("click", ()=>{
    const key = el("editKey").value;
    if(!key) return;

    LIB[key] = {
      name: (el("editName").value || "").trim() || key,
      x: safeNumber(el("editX").value, 0),
      y: safeNumber(el("editY").value, 0),
      z: safeNumber(el("editZ").value, 0),
      rho: safeNumber(el("editRho").value, 800),
      lhv: safeNumber(el("editLHV").value, 43)
    };
    saveLibrary(LIB);
    populateSelects();
  });

  el("btnNewFuel").addEventListener("click", ()=>{
    const base = "NEW_FUEL";
    let k = base;
    let n = 1;
    while(LIB[k]){ k = `${base}_${n++}`; }
    LIB[k] = { name:"New Fuel", x:11, y:22, z:0, rho:780, lhv:43.0 };
    saveLibrary(LIB);
    populateSelects();
    el("editKey").value = k;
    loadEditFields();
    update();
  });

  el("btnResetLib").addEventListener("click", ()=>{
    if(!confirm("Reset library to defaults? This will remove your custom fuels from this browser.")) return;
    LIB = structuredClone(DEFAULT_FUELS);
    saveLibrary(LIB);
    populateSelects();
  });
}

/* =========================
   Init
   ========================= */
(function init(){
  initPathwayDropdown();
  initTooltips();
  wire();
  populateSelects();
  update();
})();
</script>
</body>
</html>
