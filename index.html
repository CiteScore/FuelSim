<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FuelSim — SAF Blend + Combustor Demo (A + B)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --card2:#0f1726; --text:#e7eefc; --muted:#a7b4d1;
      --line:rgba(255,255,255,.10); --accent:#62a8ff; --warn:#ffcc66; --ok:#6dffb2;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#070c16);color:var(--text)}
    .wrap{max-width:1180px;margin:0 auto;padding:24px}
    .topbar{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .title{font-size:20px;font-weight:800;margin:0}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1.02fr 1fr;gap:16px;margin-top:16px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{background:rgba(18,26,43,.92);border:1px solid var(--line);border-radius:14px;padding:16px}
    .card h3{margin:0 0 10px;font-size:14px;letter-spacing:.2px;color:#d8e4ff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    select,input[type="text"],input[type="number"]{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:var(--card2);color:var(--text);outline:none
    }
    input[type="range"]{width:100%}
    .sliderline{display:flex;align-items:center;gap:10px}
    .pill{
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.04);
      font-size:12px;color:var(--text);min-width:110px;text-align:center
    }
    .note{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.45}
    .warn{
      margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,204,102,.35);
      background:rgba(255,204,102,.08);color:var(--warn);font-size:12px;line-height:1.45;display:none
    }
    .ok{
      margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid rgba(109,255,178,.25);
      background:rgba(109,255,178,.06);color:var(--ok);font-size:12px;line-height:1.45;display:none
    }
    .footer{margin-top:14px;color:var(--muted);font-size:11px}
    .small{font-size:11px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    button{
      padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);cursor:pointer
    }
    button.primary{background:rgba(98,168,255,.18)}
    .sep{height:1px;background:var(--line);margin:14px 0}

    /* ===== Tooltip ===== */
    .tt{position:relative;display:inline-flex;align-items:center;gap:6px;cursor:help;user-select:none}
    .tt .infoDot{
      width:16px;height:16px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--line);background:rgba(255,255,255,.05);color:var(--muted);font-size:11px;line-height:1;
    }
    .tt .tip{
      position:absolute;left:0;top:calc(100% + 8px);width:min(420px, 86vw);z-index:50;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(10,16,30,.96);
      color:var(--text);box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;
    }
    .tt:hover .tip,.tt:focus-within .tip{display:block}
    .tip .tTitle{font-size:12px;font-weight:800;margin:0 0 6px;color:#d8e4ff}
    .tip .tDef{font-size:12px;margin:0 0 6px;color:var(--muted);line-height:1.35}
    .tip .tEq{font-size:12px;margin:0;padding:8px 10px;border-radius:10px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);overflow:auto}
    .tip code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .tt .tip:before{
      content:"";position:absolute;top:-8px;left:14px;border:8px solid transparent;
      border-bottom-color:rgba(10,16,30,.96);filter: drop-shadow(0 1px 0 rgba(255,255,255,.08));
    }

    /* ===== Dials ===== */
    .dialGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:560px){ .dialGrid{grid-template-columns:1fr} }
    .dialCard{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:12px}
    .dialTop{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .dialTitle{font-size:12px;color:var(--muted)}
    .dialValue{font-size:14px;font-weight:800}
    .dialUnit{font-size:11px;color:var(--muted);margin-left:6px}
    .dialWrap{display:flex;justify-content:center;align-items:center;margin-top:8px}
    .dialSvg{width:180px;height:110px}
    .dialTrack{stroke:rgba(255,255,255,.10);stroke-width:10;fill:none;stroke-linecap:round}
    .dialProg{stroke:rgba(98,168,255,.95);stroke-width:10;fill:none;stroke-linecap:round;
      stroke-dasharray: 0 9999; transition:stroke-dasharray .25s ease;}
    .dialMinMax{display:flex;justify-content:space-between;margin-top:6px;color:var(--muted);font-size:11px}

    /* ===== Column chart ===== */
    .colChart{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:12px}
    .colTop{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .colTitle{font-size:12px;color:var(--muted)}
    .cols{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px;margin-top:10px;align-items:end}
    @media (max-width: 980px){ .cols{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
    @media (max-width: 560px){ .cols{ grid-template-columns:1fr; } }
    .col{position:relative;height:120px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.04);overflow:hidden}
    .colFill{position:absolute;left:0;right:0;bottom:0;height:0%;
      background:linear-gradient(180deg,rgba(255,204,102,.85),rgba(255,204,102,.20));transition:height .25s ease;}
    .colLbl{margin-top:6px;font-size:11px;color:var(--muted);text-align:center;display:flex;justify-content:center}
    .colLbl .tt{justify-content:center}

    /* ===== Horizontal bars ===== */
    .barBox{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:12px;margin-top:12px}
    .barTitleRow{display:flex;justify-content:space-between;align-items:baseline;gap:10px;margin-bottom:8px}
    .barTitle{font-size:12px;color:var(--muted)}
    .barRow{display:grid;grid-template-columns: 180px 1fr 120px;gap:10px;align-items:center;padding:6px 0}
    @media (max-width:560px){ .barRow{grid-template-columns:1fr} .barVal{text-align:left} }
    .barLbl{font-size:12px;color:var(--muted)}
    .barText{font-size:12px;color:var(--text);opacity:.95}
    .barTrack{height:10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);overflow:hidden}
    .barFill{height:100%;width:0%;background:linear-gradient(90deg, rgba(98,168,255,.95), rgba(255,204,102,.70));transition:width .25s ease}
    .barVal{font-size:12px;text-align:right}

    /* ===== Mini panels ===== */
    .mini{border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03);padding:12px;margin-top:12px}
    .miniHead{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .miniTitle{font-size:12px;color:var(--muted)}
    .kpiGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    @media (max-width:560px){ .kpiGrid{grid-template-columns:1fr} }
    .kpi{border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02);padding:10px}
    .kpi .kLbl{font-size:11px;color:var(--muted)}
    .kpi .kVal{font-weight:900;font-size:14px;margin-top:4px}
    .kpi .kSub{font-size:11px;color:var(--muted);margin-top:2px}

    /* ===== Charts ===== */
    .chartWrap{margin-top:10px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.02);padding:10px}
    canvas{width:100%;height:260px;display:block}
    .chartNote{margin-top:8px;font-size:11px;color:var(--muted);line-height:1.4}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <p class="title">FuelSim — Demo A + Demo B</p>
        <p class="subtitle">
          Demo A: Blend + stoichiometry + emissions screening + sizing. Demo B: 0-D combustor map (T₄ vs ϕ) using simplified energy balance.
        </p>
      </div>
      <div class="small">
        Basis: <b>mass%</b> (A + B = 100)
        <div class="footer">Website-ready: user sees inputs/outputs only.</div>
      </div>
    </div>

    <div class="grid">
      <!-- ===================== INPUTS ===================== -->
      <div class="card">
        <h3>Inputs</h3>

        <label for="fuelSearch">Search fuels (key/name/category)</label>
        <input id="fuelSearch" type="text" placeholder="Type to filter (e.g., HEFA, aromatic, ethanol, methane...)" />

        <div class="row" style="margin-top:8px">
          <div>
            <label for="fuelA">Fuel A</label>
            <select id="fuelA"></select>
          </div>
          <div>
            <label for="fuelB">Fuel B</label>
            <select id="fuelB"></select>
          </div>
        </div>

        <label>Blend ratio (mass %)</label>
        <div class="sliderline">
          <div class="pill" id="pillA">A: 70%</div>
          <input id="massA" type="range" min="0" max="100" step="1" value="70" />
          <div class="pill" id="pillB">B: 30%</div>
        </div>

        <label for="blendName">Optional blend name</label>
        <input id="blendName" type="text" placeholder="Leave blank for auto-name" />

        <div class="sep"></div>

        <h3 style="margin-top:0">Operating point (for Demo A sizing + Demo B map)</h3>

        <div class="row">
          <div>
            <label for="T3">Combustor inlet temperature T₃ (K)</label>
            <input id="T3" type="number" value="800" step="10" min="250" />
          </div>
          <div>
            <label for="P3">Combustor inlet pressure P₃ (bar) <span class="small">(optional)</span></label>
            <input id="P3" type="number" value="20" step="1" min="1" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="afrAct">Actual AFR (kg air/kg fuel) — for Demo A</label>
            <input id="afrAct" type="number" value="18.0" step="0.1" min="0" />
          </div>
          <div>
            <label for="Qth">Target thermal power Q̇ (MWₜₕ) — for Demo A sizing</label>
            <input id="Qth" type="number" value="10.0" step="0.5" min="0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="etaComb">
              <span class="tt" tabindex="0">
                Combustion efficiency η (Demo B)
                <span class="infoDot">i</span>
                <span class="tip">
                  <p class="tTitle">Combustor efficiency (screening)</p>
                  <p class="tDef">Fraction of LHV converted into sensible enthalpy rise of (fuel+air) mixture.</p>
                  <p class="tEq"><code>ΔT ≈ η·LHV / (c_p · (1+AFRact))</code></p>
                </span>
              </span>
            </label>
            <input id="etaComb" type="number" value="0.99" step="0.01" min="0.5" max="1.0" />
          </div>
          <div>
            <label for="cpMix">
              <span class="tt" tabindex="0">
                Effective cₚ (kJ/kg-K) (Demo B)
                <span class="infoDot">i</span>
                <span class="tip">
                  <p class="tTitle">Effective heat capacity (screening)</p>
                  <p class="tDef">Single cₚ representing products/air mixture across T₃→T₄. Use for trend maps only.</p>
                  <p class="tEq"><code>T4 ≈ T3 + (η·LHV·1000)/(c_p·(1+AFRact))</code></p>
                </span>
              </span>
            </label>
            <input id="cpMix" type="number" value="1.15" step="0.01" min="0.8" max="1.6" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="phiMin">Map ϕ min (Demo B)</label>
            <input id="phiMin" type="number" value="0.30" step="0.01" min="0.05" max="2.0" />
          </div>
          <div>
            <label for="phiMax">Map ϕ max (Demo B)</label>
            <input id="phiMax" type="number" value="1.60" step="0.01" min="0.05" max="3.0" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="T4target">
              <span class="tt" tabindex="0">
                Target combustor exit temperature T₄, target (K) (Demo B)
                <span class="infoDot">i</span>
                <span class="tip">
                  <p class="tTitle">Solve for ϕ or AFRact</p>
                  <p class="tDef">We numerically find ϕ that hits T₄ target using the same screening energy balance.</p>
                  <p class="tEq"><code>Find ϕ: T4(ϕ) − T4_target = 0</code></p>
                </span>
              </span>
            </label>
            <input id="T4target" type="number" value="1700" step="10" min="700" />
          </div>
          <div style="display:flex;align-items:end;gap:10px">
            <button id="btnRecompute" class="primary" style="width:100%">Recompute</button>
          </div>
        </div>

        <div class="warn" id="warnBox"></div>
        <div class="ok" id="okBox"></div>

        <div class="sep"></div>

        <!-- ===== Edit/Add Fuel ===== -->
        <h3 style="margin-top:0">Edit / Add Fuel</h3>
        <div class="note" style="margin-top:0">Edits are stored locally in this browser (no server).</div>

        <div class="row" style="margin-top:8px">
          <div>
            <label for="editKey">Fuel key to edit</label>
            <select id="editKey"></select>
          </div>
          <div>
            <label for="editName">Fuel name</label>
            <input id="editName" type="text" placeholder="Display name" />
          </div>
        </div>

        <div class="row">
          <div><label for="editXC">x (C)</label><input id="editXC" type="number" step="0.001" /></div>
          <div><label for="editYH">y (H)</label><input id="editYH" type="number" step="0.001" /></div>
        </div>

        <div class="row">
          <div><label for="editZO">z (O)</label><input id="editZO" type="number" step="0.001" /></div>
          <div><label for="editRho">Density ρ (kg/m³)</label><input id="editRho" type="number" step="0.1" /></div>
        </div>

        <div class="row">
          <div><label for="editLHV">LHV (MJ/kg)</label><input id="editLHV" type="number" step="0.01" /></div>
          <div style="display:flex;align-items:end;gap:10px">
            <button id="btnSaveFuel" class="primary" style="width:100%">Save fuel</button>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="btnNewFuel" type="button">Add new fuel key</button>
          <button id="btnResetLocal" type="button">Reset local edits</button>
        </div>

        <div id="editMsg" class="note" style="margin-top:10px"></div>
      </div>

      <!-- ===================== OUTPUTS ===================== -->
      <div class="card">
        <h3>Demo A — Blend + Screening</h3>

        <div class="dialGrid">
          <!-- LHV -->
          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">
                <span class="tt" tabindex="0">
                  LHV (MJ/kg)
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">Lower Heating Value</p>
                    <p class="tDef">Energy released per kg fuel excluding latent heat of water condensation.</p>
                    <p class="tEq"><code>LHV_blend = wA·LHV_A + wB·LHV_B</code></p>
                  </span>
                </span>
              </div>
              <div class="dialValue"><span class="mono" id="gLHV">—</span><span class="dialUnit">MJ/kg</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dLHV" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>20</span><span>50</span></div>
          </div>

          <!-- Density -->
          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">
                <span class="tt" tabindex="0">
                  Density ρ (kg/m³)
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">Density mixing</p>
                    <p class="tDef">Specific-volume mixing (approx): blend ρ is computed from mass fractions and component densities.</p>
                    <p class="tEq"><code>1/ρ_blend = wA/ρ_A + wB/ρ_B</code></p>
                  </span>
                </span>
              </div>
              <div class="dialValue"><span class="mono" id="gRho">—</span><span class="dialUnit">kg/m³</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dRho" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>650</span><span>900</span></div>
          </div>

          <!-- AFRst -->
          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">
                <span class="tt" tabindex="0">
                  AFRst (kg/kg)
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">Stoichiometric AFR</p>
                    <p class="tDef">Air–fuel ratio for complete combustion with no excess oxygen.</p>
                    <p class="tEq"><code>νO2 = x + y/4 − z/2; AFRst = (νO2·MW_O2)/(MW_fuel·Y_O2)</code></p>
                  </span>
                </span>
              </div>
              <div class="dialValue"><span class="mono" id="gAFRst">—</span><span class="dialUnit">kg/kg</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dAFR" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>5</span><span>25</span></div>
          </div>

          <!-- phi -->
          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">
                <span class="tt" tabindex="0">
                  ϕ = AFRst/AFRact
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">Equivalence ratio</p>
                    <p class="tDef">Richness: ϕ&gt;1 rich, ϕ&lt;1 lean.</p>
                    <p class="tEq"><code>ϕ = AFRst / AFRact</code></p>
                  </span>
                </span>
              </div>
              <div class="dialValue"><span class="mono" id="gPhi">—</span><span class="dialUnit">—</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dPhi" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>0.2</span><span>2.0</span></div>
          </div>

          <!-- CO2 per energy -->
          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">
                <span class="tt" tabindex="0">
                  CO₂ (g/kWhₜₕ)
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">CO₂ per thermal energy</p>
                    <p class="tDef">Ideal complete-combustion CO₂ per delivered thermal energy (LHV basis).</p>
                    <p class="tEq"><code>CO2_g/kWh = (CO2_kg/kg / LHV_MJ/kg) · 3.6 · 1000</code></p>
                  </span>
                </span>
              </div>
              <div class="dialValue"><span class="mono" id="gCO2kWh">—</span><span class="dialUnit">g/kWh</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dCO2kWh" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>150</span><span>350</span></div>
          </div>

          <!-- T4 estimate dial (Demo B key) -->
          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">
                <span class="tt" tabindex="0">
                  T₄ estimate (K) — Demo B
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">0-D combustor exit temperature (screening)</p>
                    <p class="tDef">Simple energy balance using effective cₚ and η. Uses AFRact input.</p>
                    <p class="tEq"><code>T4 ≈ T3 + (η·LHV·1000)/(c_p·(1+AFRact))</code></p>
                  </span>
                </span>
              </div>
              <div class="dialValue"><span class="mono" id="gT4">—</span><span class="dialUnit">K</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dT4" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>900</span><span>2100</span></div>
          </div>
        </div>

        <div class="colChart" style="margin-top:12px">
          <div class="colTop">
            <div class="colTitle">Key outputs (columns)</div>
            <div class="small">scaled to typical ranges</div>
          </div>

          <div class="cols">
            <div>
              <div class="col"><div class="colFill" id="cLHVvol"></div></div>
              <div class="colLbl">
                <span class="tt" tabindex="0">
                  LHV (MJ/L)
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">Volumetric LHV</p>
                    <p class="tDef">Energy per unit volume; useful for tank sizing and volume-flow comparison.</p>
                    <p class="tEq"><code>LHV_vol = LHV(MJ/kg) · ρ(kg/m³) / 1000</code></p>
                  </span>
                </span>
              </div>
              <div class="small" style="text-align:center"><span class="mono" id="bLHVvol">—</span></div>
            </div>

            <div>
              <div class="col"><div class="colFill" id="cCO2"></div></div>
              <div class="colLbl">
                <span class="tt" tabindex="0">
                  CO₂ (kg/kg)
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">CO₂ per kg fuel</p>
                    <p class="tDef">Ideal complete-combustion CO₂ produced per kg fuel.</p>
                    <p class="tEq"><code>CO2_kg/kg = x · MW_CO2 / MW_fuel</code></p>
                  </span>
                </span>
              </div>
              <div class="small" style="text-align:center"><span class="mono" id="bCO2kgkg">—</span></div>
            </div>

            <div>
              <div class="col"><div class="colFill" id="cH2O"></div></div>
              <div class="colLbl">
                <span class="tt" tabindex="0">
                  H₂O (kg/kg)
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">H₂O per kg fuel</p>
                    <p class="tDef">Water formed from hydrogen under complete combustion.</p>
                    <p class="tEq"><code>H2O_kg/kg = (y/2) · MW_H2O / MW_fuel</code></p>
                  </span>
                </span>
              </div>
              <div class="small" style="text-align:center"><span class="mono" id="bH2Okgkg">—</span></div>
            </div>

            <div>
              <div class="col"><div class="colFill" id="cQair"></div></div>
              <div class="colLbl">
                <span class="tt" tabindex="0">
                  q_air (MJ/kg air)
                  <span class="infoDot">i</span>
                  <span class="tip">
                    <p class="tTitle">Heat per kg air</p>
                    <p class="tDef">Thermal energy per kg air at the chosen AFRact.</p>
                    <p class="tEq"><code>q_air = LHV / AFRact</code></p>
                  </span>
                </span>
              </div>
              <div class="small" style="text-align:center"><span class="mono" id="bQair">—</span></div>
            </div>
          </div>
        </div>

        <div class="barBox">
          <div class="barTitleRow">
            <div class="barTitle">Computed summary (horizontal bars)</div>
            <div class="small">scaled to typical ranges</div>
          </div>

          <div class="barRow">
            <div class="barLbl">Surrogate formula</div>
            <div class="barText mono" id="tFormula">—</div>
            <div class="barVal mono"></div>
          </div>

          <div class="barRow">
            <div class="barLbl">MW (g/mol)</div>
            <div class="barTrack"><div class="barFill" id="hbMW"></div></div>
            <div class="barVal mono" id="tMW">—</div>
          </div>

          <div class="barRow">
            <div class="barLbl">νO₂ (mol/mol)</div>
            <div class="barTrack"><div class="barFill" id="hbNuO2"></div></div>
            <div class="barVal mono" id="tNuO2">—</div>
          </div>

          <div class="barRow">
            <div class="barLbl">λ (—)</div>
            <div class="barTrack"><div class="barFill" id="hbLambda"></div></div>
            <div class="barVal mono" id="tLambda">—</div>
          </div>

          <div class="barRow">
            <div class="barLbl">ṁf (kg/s) @ Q̇</div>
            <div class="barTrack"><div class="barFill" id="hbMdotF"></div></div>
            <div class="barVal mono" id="tMdotF">—</div>
          </div>

          <div class="barRow">
            <div class="barLbl">ṁa (kg/s) @ Q̇</div>
            <div class="barTrack"><div class="barFill" id="hbMdotA"></div></div>
            <div class="barVal mono" id="tMdotA">—</div>
          </div>
        </div>

        <!-- ===================== DEMO B ===================== -->
        <div class="mini">
          <div class="miniHead">
            <div class="miniTitle">
              <span class="tt" tabindex="0">
                Demo B — 0-D Combustor Map (screening)
                <span class="infoDot">i</span>
                <span class="tip">
                  <p class="tTitle">What this map is</p>
                  <p class="tDef">A simplified energy-balance map for T₄ vs ϕ. Good for trends and interactive demos; not a detailed combustor model.</p>
                  <p class="tEq"><code>T4(ϕ) ≈ T3 + (η·LHV·1000)/(c_p·(1 + AFRst/ϕ))</code></p>
                </span>
              </span>
            </div>
            <div class="small">plots update live</div>
          </div>

          <div class="kpiGrid">
            <div class="kpi">
              <div class="kLbl">ϕ to hit T₄,target</div>
              <div class="kVal mono" id="kPhiTarget">—</div>
              <div class="kSub">bisection solve within map range</div>
            </div>
            <div class="kpi">
              <div class="kLbl">AFRact at that ϕ</div>
              <div class="kVal mono" id="kAFRtarget">—</div>
              <div class="kSub">AFRact = AFRst / ϕ</div>
            </div>
            <div class="kpi">
              <div class="kLbl">T₄ at current AFRact</div>
              <div class="kVal mono" id="kT4cur">—</div>
              <div class="kSub">uses your AFRact input</div>
            </div>
          </div>

          <div class="chartWrap">
            <canvas id="chartT4"></canvas>
            <div class="chartNote">
              The line is T₄(ϕ). The vertical marker shows ϕ that meets T₄,target (if solvable within ϕ range).
              The horizontal marker shows T₄,target.
            </div>
          </div>

          <div class="chartWrap">
            <canvas id="chartAFR"></canvas>
            <div class="chartNote">
              AFRact(ϕ) = AFRst/ϕ. Useful to see how air demand changes across the map.
            </div>
          </div>

          <div class="note">
            Demo B assumptions (screening): constant effective cₚ, no dissociation, no pressure dependence, no heat loss, complete combustion.
            Use this for interactive demonstrations and trend intuition only.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <span class="mono">Tip for 123site:</span> Put this as <b>index.html</b>. Users only see the inputs/outputs in the page.
    </div>
  </div>

<script>
  /* ===================== CONSTANTS ===================== */
  const Y_O2_AIR = 0.232; // mass fraction
  const MW = { C: 12.011, H: 1.008, O: 15.999, O2: 31.998, CO2: 44.0095, H2O: 18.01528 };

  const CAT_ORDER = [
    "Conventional Jet",
    "SAF (Paraffinic)",
    "SAF (Cyclo/Aromatic)",
    "Oxygenated e-fuels (screening)",
    "Pure-component references",
    "Oxygenates (validation)",
    "Diesel/Gasoline (screening)",
    "Gases (stoichiometry checks)",
    "User (local)"
  ];

  /* ===================== DEFAULT FUEL LIBRARY ===================== */
  const DEFAULT_FUELS = {
    JetA:        { cat:"Conventional Jet", name:"Jet-A (rep)",                  xC:11.40, yH:22.10, zO:0.00, rho:803.0, LHV:43.06 },
    JetA_light:  { cat:"Conventional Jet", name:"Jet-A (lighter cut)",          xC:10.80, yH:21.60, zO:0.00, rho:790.0, LHV:43.20 },
    JetA_heavy:  { cat:"Conventional Jet", name:"Jet-A (heavier cut)",          xC:12.20, yH:23.20, zO:0.00, rho:820.0, LHV:42.90 },
    JetA_hiAro:  { cat:"Conventional Jet", name:"Jet fuel (higher aromatics)",  xC:10.80, yH:17.50, zO:0.00, rho:840.0, LHV:42.00 },
    JetA_loAro:  { cat:"Conventional Jet", name:"Jet fuel (low aromatics)",     xC:11.80, yH:25.50, zO:0.00, rho:770.0, LHV:43.90 },

    HEFA:        { cat:"SAF (Paraffinic)", name:"HEFA-SPK (rep)",               xC:11.60, yH:25.20, zO:0.00, rho:752.0, LHV:44.18 },
    FT:          { cat:"SAF (Paraffinic)", name:"FT-SPK (rep)",                 xC:12.00, yH:26.00, zO:0.00, rho:760.0, LHV:43.50 },
    ATJ:         { cat:"SAF (Paraffinic)", name:"ATJ-SPK (rep)",                xC:11.30, yH:24.80, zO:0.00, rho:760.0, LHV:43.80 },
    SIP:         { cat:"SAF (Paraffinic)", name:"SIP (iso-paraffinic)",         xC:11.00, yH:24.00, zO:0.00, rho:750.0, LHV:44.00 },
    HFS_SPK:     { cat:"SAF (Paraffinic)", name:"HFS (hydroprocessed sugars)",  xC:11.20, yH:24.40, zO:0.00, rho:748.0, LHV:44.10 },

    CHJ:         { cat:"SAF (Cyclo/Aromatic)", name:"CHJ (cycloalkane rich)",        xC:10.80, yH:19.50, zO:0.00, rho:815.0, LHV:42.60 },
    FT_SKA:      { cat:"SAF (Cyclo/Aromatic)", name:"FT-SKA (aromatics-containing)", xC:10.50, yH:16.50, zO:0.00, rho:850.0, LHV:41.80 },
    ARO_05:      { cat:"SAF (Cyclo/Aromatic)", name:"Aromatics surrogate (~5%)",     xC:11.20, yH:21.00, zO:0.00, rho:815.0, LHV:42.90 },
    ARO_10:      { cat:"SAF (Cyclo/Aromatic)", name:"Aromatics surrogate (~10%)",    xC:10.80, yH:19.00, zO:0.00, rho:840.0, LHV:42.20 },
    ARO_20:      { cat:"SAF (Cyclo/Aromatic)", name:"Aromatics surrogate (~20%)",    xC:10.20, yH:16.00, zO:0.00, rho:870.0, LHV:41.20 },

    eKero_O0:    { cat:"Oxygenated e-fuels (screening)", name:"e-Kerosene (no oxygen)",      xC:12.00, yH:26.00, zO:0.00, rho:775.0, LHV:43.80 },
    eKero_O1:    { cat:"Oxygenated e-fuels (screening)", name:"Oxygenated e-kerosene (O~1)", xC:12.00, yH:24.00, zO:1.00, rho:820.0, LHV:41.80 },
    eKero_O2:    { cat:"Oxygenated e-fuels (screening)", name:"Oxygenated e-kerosene (O~2)", xC:12.00, yH:24.00, zO:2.00, rho:840.0, LHV:40.50 },
    eKero_O3:    { cat:"Oxygenated e-fuels (screening)", name:"Oxygenated e-kerosene (O~3)", xC:12.00, yH:24.00, zO:3.00, rho:860.0, LHV:39.20 },

    nDecane:      { cat:"Pure-component references", name:"n-Decane (C10H22)",         xC:10.00, yH:22.00, zO:0.00, rho:730.0, LHV:44.60 },
    nDodecane:    { cat:"Pure-component references", name:"n-Dodecane (C12H26)",       xC:12.00, yH:26.00, zO:0.00, rho:748.0, LHV:44.00 },
    nTetradecane: { cat:"Pure-component references", name:"n-Tetradecane (C14H30)",    xC:14.00, yH:30.00, zO:0.00, rho:763.0, LHV:43.20 },
    isoOctane:    { cat:"Pure-component references", name:"Iso-octane (C8H18)",        xC: 8.00, yH:18.00, zO:0.00, rho:692.0, LHV:44.30 },
    Toluene:      { cat:"Pure-component references", name:"Toluene (C7H8)",            xC: 7.00, yH: 8.00, zO:0.00, rho:867.0, LHV:40.60 },
    Xylene:       { cat:"Pure-component references", name:"Xylene (C8H10)",            xC: 8.00, yH:10.00, zO:0.00, rho:860.0, LHV:40.00 },
    Cyclohexane:  { cat:"Pure-component references", name:"Cyclohexane (C6H12)",       xC: 6.00, yH:12.00, zO:0.00, rho:779.0, LHV:43.30 },

    MeOH:         { cat:"Oxygenates (validation)", name:"Methanol (CH4O)",             xC: 1.00, yH: 4.00, zO:1.00, rho:792.0, LHV:19.90 },
    EtOH:         { cat:"Oxygenates (validation)", name:"Ethanol (C2H6O)",             xC: 2.00, yH: 6.00, zO:1.00, rho:789.0, LHV:26.80 },
    iPrOH:        { cat:"Oxygenates (validation)", name:"Isopropanol (C3H8O)",         xC: 3.00, yH: 8.00, zO:1.00, rho:786.0, LHV:30.00 },
    BuOH:         { cat:"Oxygenates (validation)", name:"n-Butanol (C4H10O)",          xC: 4.00, yH:10.00, zO:1.00, rho:810.0, LHV:33.10 },

    Diesel:       { cat:"Diesel/Gasoline (screening)", name:"Diesel surrogate",        xC:14.00, yH:30.00, zO:0.00, rho:835.0, LHV:42.70 },

    CH4:          { cat:"Gases (stoichiometry checks)", name:"Methane (gas, ref)",     xC: 1.00, yH: 4.00, zO:0.00, rho:  0.656, LHV:50.00 },
    LCH4:         { cat:"Gases (stoichiometry checks)", name:"Liquid methane (cryogenic)", xC:1.00, yH:4.00, zO:0.00, rho:420.0, LHV:50.00 },
    H2:           { cat:"Gases (stoichiometry checks)", name:"Hydrogen (gas, ref)",    xC: 0.00, yH: 2.00, zO:0.00, rho:  0.084, LHV:120.0 }
  };

  /* ===================== LOAD + MERGE LOCAL EDITS ===================== */
  const FUELS = JSON.parse(JSON.stringify(DEFAULT_FUELS));
  try {
    const saved = localStorage.getItem("fuelsim_fuels_v2");
    if (saved) {
      const obj = JSON.parse(saved);
      for (const k of Object.keys(obj)) FUELS[k] = obj[k];
    }
  } catch(e) {}

  function saveLocalFuels(){ try{ localStorage.setItem("fuelsim_fuels_v2", JSON.stringify(FUELS)); }catch(e){} }
  function resetLocalFuels(){
    try{ localStorage.removeItem("fuelsim_fuels_v2"); }catch(e){}
    for (const k of Object.keys(FUELS)) delete FUELS[k];
    for (const k of Object.keys(DEFAULT_FUELS)) FUELS[k] = JSON.parse(JSON.stringify(DEFAULT_FUELS[k]));
  }

  /* ===================== CORE CHEM FUNCTIONS ===================== */
  function mwFuel(f){ return f.xC*MW.C + f.yH*MW.H + f.zO*MW.O; }
  function nuO2Stoich(f){ return f.xC + f.yH/4.0 - f.zO/2.0; }
  function afrStoichMass(f){
    const nu = nuO2Stoich(f);
    if (nu <= 0) throw new Error("Non-physical νO₂ ≤ 0.");
    const mwf = mwFuel(f);
    if (mwf <= 0) throw new Error("Non-physical MW_fuel ≤ 0.");
    return (nu*MW.O2) / (mwf * Y_O2_AIR);
  }
  function co2IntensityKgPerKg(f){
    const mwf = mwFuel(f);
    if (mwf <= 0) throw new Error("Non-physical MW_fuel ≤ 0.");
    return (f.xC * MW.CO2) / mwf;
  }
  function h2oIntensityKgPerKg(f){
    const mwf = mwFuel(f);
    if (mwf <= 0) throw new Error("Non-physical MW_fuel ≤ 0.");
    return ((f.yH/2.0) * MW.H2O) / mwf;
  }
  function co2PerKWhth_g(f){
    const co2kgkg = co2IntensityKgPerKg(f);
    if (f.LHV <= 0) throw new Error("Non-physical LHV ≤ 0.");
    return (co2kgkg / f.LHV) * 3.6 * 1000.0;
  }
  function blendMass2(fA,fB,wA){
    const wB = 1-wA;
    const LHV = wA*fA.LHV + wB*fB.LHV;
    const invRho = (wA/fA.rho) + (wB/fB.rho);
    const rho = 1/invRho;
    const xC = wA*fA.xC + wB*fB.xC;
    const yH = wA*fA.yH + wB*fB.yH;
    const zO = wA*fA.zO + wB*fB.zO;
    return { name:"", xC,yH,zO,rho,LHV };
  }

  /* ===================== DEMO B: 0-D COMBUSTOR SCREENING MODEL ===================== */
  // T4(phi) screening:
  // AFRact = AFRst / phi
  // T4 = T3 + (eta * LHV*1000) / (cp_kJkgK * (1 + AFRact))
  function T4_from_phi({T3, LHV_MJkg, AFRst, phi, eta, cp_kJkgK}){
    const eps = 1e-9;
    const p = Math.max(phi, eps);
    const AFRact = AFRst / p;
    const dT = (eta * LHV_MJkg * 1000.0) / (cp_kJkgK * (1.0 + AFRact));
    return { T4: T3 + dT, AFRact };
  }
  function T4_from_AFRact({T3,LHV_MJkg,AFRact,eta,cp_kJkgK}){
    const eps = 1e-9;
    const A = Math.max(AFRact, eps);
    const dT = (eta * LHV_MJkg * 1000.0) / (cp_kJkgK * (1.0 + A));
    return T3 + dT;
  }

  // Solve phi to hit T4target within [phiMin,phiMax]
  function solvePhiForT4({T3,LHV_MJkg,AFRst,eta,cp_kJkgK,phiMin,phiMax,T4target}){
    const f = (phi) => T4_from_phi({T3,LHV_MJkg,AFRst,phi,eta,cp_kJkgK}).T4 - T4target;

    let a = phiMin, b = phiMax;
    let fa = f(a), fb = f(b);
    if (!Number.isFinite(fa) || !Number.isFinite(fb)) return { ok:false, phi:NaN, AFRact:NaN };
    if (fa === 0) {
      const out = T4_from_phi({T3,LHV_MJkg,AFRst,phi:a,eta,cp_kJkgK});
      return { ok:true, phi:a, AFRact:out.AFRact };
    }
    if (fb === 0) {
      const out = T4_from_phi({T3,LHV_MJkg,AFRst,phi:b,eta,cp_kJkgK});
      return { ok:true, phi:b, AFRact:out.AFRact };
    }
    if (fa*fb > 0) return { ok:false, phi:NaN, AFRact:NaN };

    // bisection
    for (let i=0;i<70;i++){
      const m = 0.5*(a+b);
      const fm = f(m);
      if (!Number.isFinite(fm)) break;
      if (Math.abs(fm) < 1e-6) {
        const out = T4_from_phi({T3,LHV_MJkg,AFRst,phi:m,eta,cp_kJkgK});
        return { ok:true, phi:m, AFRact:out.AFRact };
      }
      if (fa*fm <= 0){ b=m; fb=fm; }
      else { a=m; fa=fm; }
    }
    const m = 0.5*(a+b);
    const out = T4_from_phi({T3,LHV_MJkg,AFRst,phi:m,eta,cp_kJkgK});
    return { ok:true, phi:m, AFRact:out.AFRact };
  }

  /* ===================== UI HELPERS ===================== */
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function fmt(x,n=3){ return Number(x).toFixed(n); }
  function setDial(pathEl, value, vmin, vmax){
    if (!pathEl) return;
    if (!Number.isFinite(value)) { pathEl.style.strokeDasharray = "0 9999"; return; }
    const p = clamp01((value - vmin) / (vmax - vmin));
    const arc = 251;
    pathEl.style.strokeDasharray = `${(p*arc).toFixed(1)} 9999`;
  }
  function setCol(el,value,vmin,vmax){
    if (!el) return;
    if (!Number.isFinite(value)) { el.style.height="0%"; return; }
    const p = clamp01((value-vmin)/(vmax-vmin));
    el.style.height = (p*100).toFixed(1)+"%";
  }
  function setHBar(el,value,vmin,vmax){
    if (!el) return;
    if (!Number.isFinite(value)) { el.style.width="0%"; return; }
    const p = clamp01((value-vmin)/(vmax-vmin));
    el.style.width = (p*100).toFixed(1)+"%";
  }
  function showBox(el,msg){
    if (!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="block"; el.textContent = msg;
  }

  /* ===================== DOM ===================== */
  const elFuelSearch = document.getElementById("fuelSearch");
  const elFuelA = document.getElementById("fuelA");
  const elFuelB = document.getElementById("fuelB");
  const elMassA = document.getElementById("massA");
  const elPillA = document.getElementById("pillA");
  const elPillB = document.getElementById("pillB");
  const elName  = document.getElementById("blendName");

  const elT3 = document.getElementById("T3");
  const elP3 = document.getElementById("P3"); // currently not used in equations (kept for roadmap)
  const elAfrAct = document.getElementById("afrAct");
  const elQth = document.getElementById("Qth");
  const elEta = document.getElementById("etaComb");
  const elCp  = document.getElementById("cpMix");
  const elPhiMin = document.getElementById("phiMin");
  const elPhiMax = document.getElementById("phiMax");
  const elT4target = document.getElementById("T4target");

  const warnBox = document.getElementById("warnBox");
  const okBox = document.getElementById("okBox");

  // dials
  const gLHV = document.getElementById("gLHV");
  const gRho = document.getElementById("gRho");
  const gAFRst = document.getElementById("gAFRst");
  const gPhi = document.getElementById("gPhi");
  const gCO2kWh = document.getElementById("gCO2kWh");
  const gT4 = document.getElementById("gT4");
  const dLHV = document.getElementById("dLHV");
  const dRho = document.getElementById("dRho");
  const dAFR = document.getElementById("dAFR");
  const dPhi = document.getElementById("dPhi");
  const dCO2kWh = document.getElementById("dCO2kWh");
  const dT4 = document.getElementById("dT4");

  // columns
  const cLHVvol = document.getElementById("cLHVvol");
  const cCO2 = document.getElementById("cCO2");
  const cH2O = document.getElementById("cH2O");
  const cQair = document.getElementById("cQair");
  const bLHVvol = document.getElementById("bLHVvol");
  const bCO2kgkg = document.getElementById("bCO2kgkg");
  const bH2Okgkg = document.getElementById("bH2Okgkg");
  const bQair = document.getElementById("bQair");

  // bars
  const tFormula = document.getElementById("tFormula");
  const tMW = document.getElementById("tMW");
  const tNuO2 = document.getElementById("tNuO2");
  const tLambda = document.getElementById("tLambda");
  const tMdotF = document.getElementById("tMdotF");
  const tMdotA = document.getElementById("tMdotA");
  const hbMW = document.getElementById("hbMW");
  const hbNuO2 = document.getElementById("hbNuO2");
  const hbLambda = document.getElementById("hbLambda");
  const hbMdotF = document.getElementById("hbMdotF");
  const hbMdotA = document.getElementById("hbMdotA");

  // demo B KPIs
  const kPhiTarget = document.getElementById("kPhiTarget");
  const kAFRtarget = document.getElementById("kAFRtarget");
  const kT4cur = document.getElementById("kT4cur");

  // charts
  const cvT4 = document.getElementById("chartT4");
  const cvAFR = document.getElementById("chartAFR");

  /* ===================== EDITOR ===================== */
  const elEditKey  = document.getElementById("editKey");
  const elEditName = document.getElementById("editName");
  const elEditXC   = document.getElementById("editXC");
  const elEditYH   = document.getElementById("editYH");
  const elEditZO   = document.getElementById("editZO");
  const elEditRho  = document.getElementById("editRho");
  const elEditLHV  = document.getElementById("editLHV");
  const elEditMsg  = document.getElementById("editMsg");

  function fuelKeys(){ return Object.keys(FUELS).sort(); }
  function getCategory(k){ return FUELS[k]?.cat || "User (local)"; }
  function matchesFilter(k,filter){
    if (!filter) return true;
    const f = FUELS[k];
    const t = filter.toLowerCase().trim();
    const hay = (k+" "+(f?.name||"")+" "+(f?.cat||"")).toLowerCase();
    return hay.includes(t);
  }
  function rebuildDropdownGrouped(sel, keepValue, filterText){
    const prev = keepValue ?? sel.value;
    sel.innerHTML = "";
    const keys = fuelKeys().filter(k => matchesFilter(k, filterText));
    const byCat = new Map();
    for (const k of keys){
      const cat = getCategory(k);
      if (!byCat.has(cat)) byCat.set(cat, []);
      byCat.get(cat).push(k);
    }
    let added = 0;
    for (const cat of CAT_ORDER){
      const arr = byCat.get(cat);
      if (!arr || arr.length===0) continue;
      const og = document.createElement("optgroup");
      og.label = cat;
      for (const k of arr){
        const f = FUELS[k];
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = `${k} — ${f.name}`;
        og.appendChild(opt);
        added++;
      }
      sel.appendChild(og);
    }
    for (const [cat,arr] of byCat.entries()){
      if (CAT_ORDER.includes(cat)) continue;
      const og = document.createElement("optgroup");
      og.label = cat;
      for (const k of arr){
        const f = FUELS[k];
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = `${k} — ${f.name}`;
        og.appendChild(opt);
        added++;
      }
      sel.appendChild(og);
    }
    if (added===0){
      const opt = document.createElement("option");
      opt.value=""; opt.textContent="No matches"; opt.disabled=true; opt.selected=true;
      sel.appendChild(opt);
      return;
    }
    if (prev && FUELS[prev] && keys.includes(prev)) sel.value = prev;
    else sel.value = keys[0];
  }
  function loadEditorFromKey(k){
    const f = FUELS[k]; if (!f) return;
    elEditName.value = f.name ?? k;
    elEditXC.value = f.xC;
    elEditYH.value = f.yH;
    elEditZO.value = f.zO;
    elEditRho.value = f.rho;
    elEditLHV.value = f.LHV;
  }
  function refreshAllDropdowns(){
    const filterText = elFuelSearch.value || "";
    const a = elFuelA.value || "JetA";
    const b = elFuelB.value || "HEFA";
    const e = elEditKey.value || "JetA";

    rebuildDropdownGrouped(elFuelA, a, filterText);
    rebuildDropdownGrouped(elFuelB, b, filterText);
    rebuildDropdownGrouped(elEditKey, e, filterText);

    if (elFuelA.value && elFuelB.value && elFuelA.value === elFuelB.value){
      const keys = fuelKeys().filter(k => matchesFilter(k, filterText));
      const alt = keys.find(x => x !== elFuelA.value);
      if (alt) elFuelB.value = alt;
    }
    if (elEditKey.value) loadEditorFromKey(elEditKey.value);
    update();
  }

  document.getElementById("btnSaveFuel").addEventListener("click", () => {
    const k = (elEditKey.value || "").trim();
    if (!k){ elEditMsg.textContent="Error: choose a fuel key."; return; }

    const name = (elEditName.value || "").trim() || k;
    const xC = Number(elEditXC.value);
    const yH = Number(elEditYH.value);
    const zO = Number(elEditZO.value);
    const rho = Number(elEditRho.value);
    const LHV = Number(elEditLHV.value);

    if (![xC,yH,zO,rho,LHV].every(v => Number.isFinite(v))){
      elEditMsg.textContent="Error: numeric fields must be valid numbers.";
      return;
    }
    if (xC<0 || yH<0 || zO<0 || rho<=0 || LHV<=0){
      elEditMsg.textContent="Error: non-physical values (check rho/LHV and x/y/z).";
      return;
    }

    const existing = FUELS[k] || {};
    const cat = existing.cat || "User (local)";
    FUELS[k] = { cat, name, xC, yH, zO, rho, LHV };
    saveLocalFuels();
    elEditMsg.textContent = `Saved '${k}' locally.`;
    refreshAllDropdowns();
  });

  document.getElementById("btnNewFuel").addEventListener("click", () => {
    const newKey = prompt("Enter new fuel key (e.g., eKeroX):");
    if (!newKey) return;
    const k = newKey.trim();
    if (!k) return;
    if (!FUELS[k]){
      FUELS[k] = { cat:"User (local)", name:k, xC:12, yH:26, zO:0, rho:780, LHV:43.3 };
      saveLocalFuels();
    }
    refreshAllDropdowns();
    elEditKey.value = k;
    loadEditorFromKey(k);
    elEditMsg.textContent = `Created '${k}'. Update properties and Save.`;
  });

  document.getElementById("btnResetLocal").addEventListener("click", () => {
    if (!confirm("Reset local edits? (Removes fuels saved in THIS browser only)")) return;
    resetLocalFuels();
    elEditMsg.textContent="Local edits cleared (defaults restored).";
    refreshAllDropdowns();
  });

  elEditKey.addEventListener("change", () => loadEditorFromKey(elEditKey.value));

  /* ===================== SIMPLE CANVAS PLOTTER ===================== */
  function fitCanvas(canvas){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const w = Math.max(300, Math.floor(rect.width * dpr));
    const h = Math.max(220, Math.floor(rect.height * dpr));
    if (canvas.width !== w || canvas.height !== h){
      canvas.width = w;
      canvas.height = h;
    }
    return { w, h, dpr };
  }
  function drawAxes(ctx, x0, y0, w, h){
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.rect(x0, y0, w, h);
    ctx.stroke();
    ctx.restore();
  }
  function drawLine(ctx, xs, ys, xMap, yMap){
    ctx.save();
    ctx.strokeStyle = "rgba(98,168,255,.95)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0;i<xs.length;i++){
      const x = xMap(xs[i]);
      const y = yMap(ys[i]);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    ctx.restore();
  }
  function drawHLine(ctx, y, x0, x1){
    ctx.save();
    ctx.strokeStyle = "rgba(255,204,102,.70)";
    ctx.setLineDash([6,5]);
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x0,y); ctx.lineTo(x1,y);
    ctx.stroke();
    ctx.restore();
  }
  function drawVLine(ctx, x, y0, y1){
    ctx.save();
    ctx.strokeStyle = "rgba(255,204,102,.70)";
    ctx.setLineDash([6,5]);
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x,y0); ctx.lineTo(x,y1);
    ctx.stroke();
    ctx.restore();
  }
  function label(ctx, text, x, y, align="left"){
    ctx.save();
    ctx.fillStyle = "rgba(231,238,252,.92)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = align;
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y);
    ctx.restore();
  }
  function tiny(ctx, text, x, y, align="left"){
    ctx.save();
    ctx.fillStyle = "rgba(167,180,209,.92)";
    ctx.font = "11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = align;
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  function plot(canvas, title, xLabel, yLabel, xs, ys, markers){
    const ctx = canvas.getContext("2d");
    const { w, h } = fitCanvas(canvas);
    ctx.clearRect(0,0,w,h);

    const padL = 54, padR = 16, padT = 28, padB = 44;
    const x0 = padL, y0 = padT, pw = w - padL - padR, ph = h - padT - padB;

    const xmin = Math.min(...xs), xmax = Math.max(...xs);
    const ymin = Math.min(...ys), ymax = Math.max(...ys);
    const yPad = (ymax - ymin) * 0.06 || 1;
    const yMin2 = ymin - yPad, yMax2 = ymax + yPad;

    const xMap = (x)=> x0 + ( (x - xmin) / (xmax - xmin || 1) ) * pw;
    const yMap = (y)=> y0 + (1 - ( (y - yMin2) / (yMax2 - yMin2 || 1) )) * ph;

    // frame
    drawAxes(ctx, x0, y0, pw, ph);

    // title
    label(ctx, title, x0, 14, "left");

    // axes labels
    tiny(ctx, xLabel, x0 + pw/2, h - 18, "center");
    ctx.save();
    ctx.translate(16, y0 + ph/2);
    ctx.rotate(-Math.PI/2);
    tiny(ctx, yLabel, 0, 0, "center");
    ctx.restore();

    // ticks (simple)
    const nTicks = 5;
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.fillStyle = "rgba(167,180,209,.92)";
    ctx.font = "11px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    for (let i=0;i<=nTicks;i++){
      const t = i/nTicks;
      const y = y0 + (1-t)*ph;
      ctx.beginPath(); ctx.moveTo(x0, y); ctx.lineTo(x0+pw, y); ctx.stroke();
      const val = yMin2 + t*(yMax2-yMin2);
      ctx.textAlign="right"; ctx.textBaseline="middle";
      ctx.fillText(val.toFixed(0), x0-8, y);
    }
    for (let i=0;i<=nTicks;i++){
      const t = i/nTicks;
      const x = x0 + t*pw;
      ctx.beginPath(); ctx.moveTo(x, y0); ctx.lineTo(x, y0+ph); ctx.stroke();
      const val = xmin + t*(xmax-xmin);
      ctx.textAlign="center"; ctx.textBaseline="top";
      ctx.fillText(val.toFixed(2), x, y0+ph+8);
    }
    ctx.restore();

    // line
    drawLine(ctx, xs, ys, xMap, yMap);

    // markers: {xLine, yLine}
    if (markers?.yLine != null){
      const y = yMap(markers.yLine);
      drawHLine(ctx, y, x0, x0+pw);
      tiny(ctx, `${markers.yLine.toFixed(0)}`, x0+pw-6, y-10, "right");
    }
    if (markers?.xLine != null){
      const x = xMap(markers.xLine);
      drawVLine(ctx, x, y0, y0+ph);
      tiny(ctx, `${markers.xLine.toFixed(3)}`, x, y0-10, "center");
    }
  }

  /* ===================== UPDATE CORE ===================== */
  function update(){
    // inputs
    const keyA = elFuelA.value;
    const keyB = elFuelB.value;
    const wA_pct = Number(elMassA.value);
    const wA = wA_pct/100.0;
    const wB_pct = 100 - wA_pct;

    elPillA.textContent = `A: ${wA_pct.toFixed(0)}%`;
    elPillB.textContent = `B: ${wB_pct.toFixed(0)}%`;

    if (!keyA || !keyB || !FUELS[keyA] || !FUELS[keyB]){
      showBox(warnBox, "Fuel selection is missing (check filter).");
      showBox(okBox, "");
      return;
    }
    if (keyA === keyB){
      showBox(warnBox, "Please choose two different fuels.");
      showBox(okBox, "");
      return;
    }

    // cryogenic note
    if ((keyA==="LCH4" && ["JetA","HEFA","FT","ATJ"].includes(keyB)) || (keyB==="LCH4" && ["JetA","HEFA","FT","ATJ"].includes(keyA))){
      showBox(warnBox, "Note: Liquid methane is cryogenic; blending with Jet fuels is not a practical handling basis. Use for screening only.");
    } else {
      showBox(warnBox, "");
    }

    try{
      const fA = FUELS[keyA];
      const fB = FUELS[keyB];
      const blend = blendMass2(fA,fB,wA);

      const mwf = mwFuel(blend);
      const nuO2 = nuO2Stoich(blend);
      const afr_st = afrStoichMass(blend);
      const co2kgkg = co2IntensityKgPerKg(blend);
      const h2okgkg = h2oIntensityKgPerKg(blend);
      const co2gkWh = co2PerKWhth_g(blend);
      const LHVvol = blend.LHV * blend.rho / 1000.0;

      const AFRact = Number(elAfrAct.value);
      const QthMW = Number(elQth.value);

      const hasAFR = Number.isFinite(AFRact) && AFRact>0;
      const hasQ = Number.isFinite(QthMW) && QthMW>0;

      // Demo A derived
      let phi = NaN, lambda = NaN, q_air = NaN;
      let mdot_f = NaN, mdot_a = NaN;

      if (hasAFR){
        phi = afr_st / AFRact;
        lambda = (phi>0) ? 1.0/phi : NaN;
        q_air = blend.LHV / AFRact;

        if (hasQ){
          const Q_MJps = QthMW; // 1 MW = 1 MJ/s
          mdot_f = Q_MJps / blend.LHV;
          mdot_a = AFRact * mdot_f;
        }
      }

      // Demo B: T4 using AFRact input
      const T3 = Number(elT3.value);
      const eta = Number(elEta.value);
      const cp = Number(elCp.value);

      let T4cur = NaN;
      if (Number.isFinite(T3) && Number.isFinite(eta) && Number.isFinite(cp) && hasAFR){
        T4cur = T4_from_AFRact({T3, LHV_MJkg:blend.LHV, AFRact, eta, cp_kJkgK:cp});
      }

      // Fill dials
      gLHV.textContent = fmt(blend.LHV,2);     setDial(dLHV, blend.LHV, 20, 50);
      gRho.textContent = fmt(blend.rho,1);     setDial(dRho, blend.rho, 650, 900);
      gAFRst.textContent = fmt(afr_st,2);      setDial(dAFR, afr_st, 5, 25);
      gCO2kWh.textContent = fmt(co2gkWh,1);    setDial(dCO2kWh, co2gkWh, 150, 350);

      if (hasAFR){
        gPhi.textContent = fmt(phi,3);         setDial(dPhi, phi, 0.2, 2.0);
      } else {
        gPhi.textContent = "—";               setDial(dPhi, NaN, 0.2, 2.0);
      }

      if (Number.isFinite(T4cur)){
        gT4.textContent = fmt(T4cur,0);        setDial(dT4, T4cur, 900, 2100);
      } else {
        gT4.textContent = "—";                setDial(dT4, NaN, 900, 2100);
      }

      // Columns
      bLHVvol.textContent = fmt(LHVvol,2); setCol(cLHVvol, LHVvol, 10, 40);
      bCO2kgkg.textContent = fmt(co2kgkg,3); setCol(cCO2, co2kgkg, 1.5, 3.5);
      bH2Okgkg.textContent = fmt(h2okgkg,3); setCol(cH2O, h2okgkg, 0.5, 2.0);

      if (hasAFR){
        bQair.textContent = fmt(q_air,3); setCol(cQair, q_air, 0.5, 5.0);
      } else {
        bQair.textContent = "—"; setCol(cQair, NaN, 0.5, 5.0);
      }

      // Bars
      tFormula.textContent = `C${fmt(blend.xC,3)}H${fmt(blend.yH,3)}O${fmt(blend.zO,3)}`;
      tMW.textContent = fmt(mwf,2);
      tNuO2.textContent = fmt(nuO2,4);

      if (hasAFR){
        tLambda.textContent = fmt(lambda,3);
        setHBar(hbLambda, lambda, 0.5, 3.0);
      } else {
        tLambda.textContent = "—";
        setHBar(hbLambda, NaN, 0.5, 3.0);
      }

      setHBar(hbMW, mwf, 120, 200);
      setHBar(hbNuO2, nuO2, 10, 25);

      if (hasAFR && hasQ){
        tMdotF.textContent = fmt(mdot_f,6);
        tMdotA.textContent = fmt(mdot_a,6);
        setHBar(hbMdotF, mdot_f, 0.0, 1.0);
        setHBar(hbMdotA, mdot_a, 0.0, 25.0);
      } else {
        tMdotF.textContent = "—";
        tMdotA.textContent = "—";
        setHBar(hbMdotF, NaN, 0.0, 1.0);
        setHBar(hbMdotA, NaN, 0.0, 25.0);
      }

      // ===== Demo B: map generation =====
      const phiMin = Number(elPhiMin.value);
      const phiMax = Number(elPhiMax.value);
      const T4tar = Number(elT4target.value);

      const okInputsB = [T3,eta,cp,phiMin,phiMax,T4tar].every(Number.isFinite) && (phiMax > phiMin) && (phiMin > 0) && (cp>0) && (eta>0);

      let phiSolve = { ok:false, phi:NaN, AFRact:NaN };
      let mapPhi = [], mapT4 = [], mapAFR = [];
      if (okInputsB){
        const n = 90;
        for (let i=0;i<n;i++){
          const phi_i = phiMin + (phiMax-phiMin) * (i/(n-1));
          const out = T4_from_phi({T3, LHV_MJkg:blend.LHV, AFRst:afr_st, phi:phi_i, eta, cp_kJkgK:cp});
          mapPhi.push(phi_i);
          mapT4.push(out.T4);
          mapAFR.push(out.AFRact);
        }
        phiSolve = solvePhiForT4({
          T3, LHV_MJkg:blend.LHV, AFRst:afr_st, eta, cp_kJkgK:cp,
          phiMin, phiMax, T4target:T4tar
        });
      }

      // KPI boxes
      if (phiSolve.ok){
        kPhiTarget.textContent = fmt(phiSolve.phi,3);
        kAFRtarget.textContent = fmt(phiSolve.AFRact,2);
        showBox(okBox, `Demo B: solvable — ϕ ≈ ${fmt(phiSolve.phi,3)} hits T₄,target ≈ ${fmt(T4tar,0)} K (within map range).`);
      } else {
        kPhiTarget.textContent = "—";
        kAFRtarget.textContent = "—";
        if (okInputsB){
          showBox(okBox, "");
          showBox(warnBox, warnBox.textContent || "Demo B: target T₄ is not reachable within the chosen ϕ range (try expanding ϕ min/max or adjusting inputs).");
        } else {
          showBox(okBox, "");
        }
      }

      kT4cur.textContent = Number.isFinite(T4cur) ? fmt(T4cur,0) : "—";

      // charts
      if (mapPhi.length){
        plot(cvT4, "T₄ vs ϕ (0-D screening)", "ϕ (—)", "T₄ (K)", mapPhi, mapT4, {
          xLine: phiSolve.ok ? phiSolve.phi : null,
          yLine: Number.isFinite(T4tar) ? T4tar : null
        });
        plot(cvAFR, "AFRact vs ϕ", "ϕ (—)", "AFRact (kg/kg)", mapPhi, mapAFR, {
          xLine: phiSolve.ok ? phiSolve.phi : null,
          yLine: phiSolve.ok ? phiSolve.AFRact : null
        });
      } else {
        // clear
        const ctx1 = cvT4.getContext("2d"); fitCanvas(cvT4); ctx1.clearRect(0,0,cvT4.width,cvT4.height);
        const ctx2 = cvAFR.getContext("2d"); fitCanvas(cvAFR); ctx2.clearRect(0,0,cvAFR.width,cvAFR.height);
      }

    } catch(e){
      showBox(warnBox, "Computation error: " + (e?.message || e));
      showBox(okBox, "");
    }
  }

  /* ===================== EVENTS ===================== */
  elFuelA.addEventListener("change", update);
  elFuelB.addEventListener("change", update);
  elMassA.addEventListener("input", update);
  elName.addEventListener("input", update);
  elFuelSearch.addEventListener("input", refreshAllDropdowns);

  [elT3,elP3,elAfrAct,elQth,elEta,elCp,elPhiMin,elPhiMax,elT4target].forEach(el => {
    el.addEventListener("input", update);
  });

  document.getElementById("btnRecompute").addEventListener("click", update);

  window.addEventListener("resize", () => update());

  /* ===================== INIT ===================== */
  function init(){
    refreshAllDropdowns();
    // default selection
    if (FUELS.HEFA) elFuelA.value = "HEFA";
    if (FUELS.JetA) elFuelB.value = "JetA";
    update();
  }
  init();
</script>
</body>
</html>
