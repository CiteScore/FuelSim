<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fuel Blend Calculator (Mass %)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --card2:#0f1726; --text:#e7eefc; --muted:#a7b4d1;
      --line:rgba(255,255,255,.10); --accent:#62a8ff; --warn:#ffcc66;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#070c16);color:var(--text)}
    .wrap{max-width:1020px;margin:0 auto;padding:24px}
    .topbar{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .title{font-size:20px;font-weight:700;margin:0}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{background:rgba(18,26,43,.92);border:1px solid var(--line);border-radius:14px;padding:16px}
    .card h3{margin:0 0 10px;font-size:14px;letter-spacing:.2px;color:#d8e4ff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    select,input[type="text"],input[type="number"]{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:var(--card2);color:var(--text);outline:none
    }
    input[type="range"]{width:100%}
    .sliderline{display:flex;align-items:center;gap:10px}
    .pill{
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.04);
      font-size:12px;color:var(--text);min-width:110px;text-align:center
    }
    .note{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.45}
    .warn{
      margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,204,102,.35);
      background:rgba(255,204,102,.08);color:var(--warn);font-size:12px;line-height:1.45;display:none
    }
    .footer{margin-top:14px;color:var(--muted);font-size:11px}
    .small{font-size:11px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    button{
      padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);cursor:pointer
    }
    button.primary{background:rgba(98,168,255,.18)}

    .rangeBox{
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(255,255,255,.02);
      padding:10px 10px 8px;
    }
    .rangeHead{display:flex;justify-content:space-between;align-items:baseline;gap:10px;margin-bottom:6px}
    .rangeVal{
      padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.04);
      font-size:12px;color:var(--text);white-space:nowrap
    }
    .rangeSub{display:flex;justify-content:space-between;margin-top:6px;color:var(--muted);font-size:11px}
    .rangeBtns{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .rangeBtns button{padding:7px 10px;font-size:12px}

    .tt{
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: help;
      user-select: none;
    }
    .tt .infoDot{
      width:16px;height:16px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:11px;
      line-height:1;
    }
    .tt .tip{
      position:absolute;
      left:0;
      top: calc(100% + 8px);
      width: min(360px, 80vw);
      z-index: 50;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(10,16,30,.96);
      color:var(--text);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:none;
      transform:translateY(2px);
    }
    .tt:hover .tip, .tt:focus-within .tip{ display:block; }
    .tip .tTitle{font-size:12px;font-weight:700;margin:0 0 6px;color:#d8e4ff}
    .tip .tDef{font-size:12px;margin:0 0 6px;color:var(--muted);line-height:1.35}
    .tip .tEq{
      font-size:12px;margin:0;padding:8px 10px;border-radius:10px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);overflow:auto
    }
    .tip code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .tt .tip:before{
      content:"";
      position:absolute;
      top:-8px; left:14px;
      border:8px solid transparent;
      border-bottom-color:rgba(10,16,30,.96);
      filter: drop-shadow(0 1px 0 rgba(255,255,255,.08));
    }

    .dialGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:520px){ .dialGrid{grid-template-columns:1fr} }
    .dialCard{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:12px}
    .dialTop{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .dialTitle{font-size:12px;color:var(--muted)}
    .dialValue{font-size:14px;font-weight:700}
    .dialUnit{font-size:11px;color:var(--muted);margin-left:6px}
    .dialWrap{display:flex;justify-content:center;align-items:center;margin-top:8px}
    .dialSvg{width:180px;height:110px}
    .dialTrack{stroke:rgba(255,255,255,.10);stroke-width:10;fill:none;stroke-linecap:round}
    .dialProg{
      stroke:rgba(98,168,255,.95);stroke-width:10;fill:none;stroke-linecap:round;
      stroke-dasharray: 0 9999; transition:stroke-dasharray .25s ease;
    }
    .dialMinMax{display:flex;justify-content:space-between;margin-top:6px;color:var(--muted);font-size:11px}

    .colChart{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:12px}
    .colTop{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .colTitle{font-size:12px;color:var(--muted)}
    .colValue{font-size:14px;font-weight:700}
    .cols{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
      align-items:end;
    }
    @media (max-width: 900px){ .cols{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
    @media (max-width: 520px){ .cols{ grid-template-columns:1fr; } }
    .cols > div{ min-width:0; }
    .col{
      position:relative;
      height:120px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(255,255,255,.04);
      overflow:hidden
    }
    .colFill{
      position:absolute;left:0;right:0;bottom:0;height:0%;
      background:linear-gradient(180deg,rgba(255,204,102,.85),rgba(255,204,102,.20));
      transition:height .25s ease;
    }
    .colLbl{margin-top:6px;font-size:11px;color:var(--muted);text-align:center;display:flex;justify-content:center}
    .colLbl .tt{justify-content:center}

    .barBox{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.03);
      padding:12px;
      margin-top:12px;
    }
    .barTitleRow{display:flex;justify-content:space-between;align-items:baseline;gap:10px;margin-bottom:8px}
    .barTitle{font-size:12px;color:var(--muted)}
    .barRow{
      display:grid;
      grid-template-columns: 170px 1fr 110px;
      gap:10px;
      align-items:center;
      padding:6px 0;
    }
    @media (max-width:520px){
      .barRow{ grid-template-columns: 1fr; }
      .barVal{ text-align:left; }
    }
    .barLbl{font-size:12px;color:var(--muted)}
    .barText{font-size:12px;color:var(--text);opacity:.95}
    .barTrack{
      height:10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);overflow:hidden;
    }
    .barFill{
      height:100%;width:0%;
      background:linear-gradient(90deg, rgba(98,168,255,.95), rgba(255,204,102,.70));
      transition:width .25s ease;
    }
    .barVal{font-size:12px;text-align:right}

    /* schematic */
    #schem{ transition: transform .25s ease; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <p class="title">Fuel Blend Calculator</p>
        <p class="subtitle">
          Two-component blending by <b>mass %</b>. Visual outputs: dials + columns, surrogate formula, stoichiometry, and sizing metrics.
        </p>
      </div>
      <div class="small">
        Basis: <b>mass%</b> (A + B = 100)
        <div class="footer">Screening tool: transparent assumptions, trend-focused.</div>
      </div>
    </div>

    <div class="grid">
      <!-- Inputs -->
      <div class="card">
        <h3>Inputs</h3>

        <label for="fuelSearch">Search fuels (key or name)</label>
        <input id="fuelSearch" type="text" placeholder="Type to filter dropdowns (e.g., HEFA, aromatic, ethanol, methane...)" />

        <div class="row" style="margin-top:8px">
          <div>
            <label for="fuelA">Fuel A</label>
            <select id="fuelA"></select>
          </div>
          <div>
            <label for="fuelB">Fuel B</label>
            <select id="fuelB"></select>
          </div>
        </div>

        <label>Blend ratio (mass %)</label>
        <div class="sliderline">
          <div class="pill" id="pillA">A: 70%</div>
          <input id="massA" type="range" min="0" max="100" step="1" value="70" />
          <div class="pill" id="pillB">B: 30%</div>
        </div>

        <label for="blendName">Optional blend name</label>
        <input id="blendName" type="text" placeholder="Leave blank for auto-name" />

        <div style="margin-top:14px; padding:12px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
            <div style="font-weight:700; font-size:12px; color:#d8e4ff">Operating inputs (optional)</div>
            <div class="small">Enable ϕ, λ, sizing</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="afrActRange">Actual AFR (kg air / kg fuel)</label>
              <div class="rangeBox">
                <div class="rangeHead">
                  <div class="small">AFRact</div>
                  <div class="rangeVal mono" id="afrActVal">18.0</div>
                </div>
                <input id="afrActRange" type="range" min="5" max="35" step="0.1" value="18.0" />
                <div class="rangeSub"><span>5</span><span>35</span></div>
                <div class="rangeBtns">
                  <button type="button" id="afrClear">Clear</button>
                  <button type="button" id="afrStoich">Set = AFRst</button>
                </div>
              </div>
            </div>

            <div>
              <label for="qthMWRange">Target thermal power Q̇ (MWₜₕ)</label>
              <div class="rangeBox">
                <div class="rangeHead">
                  <div class="small">Q̇</div>
                  <div class="rangeVal mono" id="qthMWVal">10.0</div>
                </div>
                <input id="qthMWRange" type="range" min="0" max="50" step="0.5" value="10.0" />
                <div class="rangeSub"><span>0</span><span>50</span></div>
                <div class="rangeBtns">
                  <button type="button" id="qClear">Clear</button>
                  <button type="button" id="q10">10 MW</button>
                  <button type="button" id="q50">50 MW</button>
                </div>
              </div>
            </div>
          </div>

          <div class="note">
            AFR slider controls φ and λ. If Q̇ &gt; 0, the tool computes ṁf and ṁa.
            Use <b>Clear</b> to disable a slider’s effect.
          </div>
        </div>

        <div class="note">
          <b>Reference density field:</b> uses each fuel’s stated reference density (often 15°C for liquids; cryogenic for LCH₄).<br/>
          Mixing uses specific-volume rule (engineering approximation).
        </div>

        <div class="warn" id="warnBox"></div>

        <!-- Edit/Add Fuel -->
        <div style="margin-top:14px; padding:12px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
            <div style="font-weight:700; font-size:12px; color:#d8e4ff">Edit / Add Fuel</div>
            <div class="small">Saved locally in this browser</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="editKey">Fuel key to edit</label>
              <select id="editKey"></select>
            </div>
            <div>
              <label for="editName">Fuel name</label>
              <input id="editName" type="text" placeholder="Display name" />
            </div>
          </div>

          <div class="row">
            <div><label for="editXC">xC</label><input id="editXC" type="text" placeholder="e.g., 12" /></div>
            <div><label for="editYH">yH</label><input id="editYH" type="text" placeholder="e.g., 26" /></div>
          </div>

          <div class="row">
            <div><label for="editZO">zO</label><input id="editZO" type="text" placeholder="e.g., 0" /></div>
            <div><label for="editRho">Density ρ (kg/m³)</label><input id="editRho" type="text" placeholder="e.g., 780" /></div>
          </div>

          <div class="row">
            <div><label for="editLHV">LHV (MJ/kg)</label><input id="editLHV" type="text" placeholder="e.g., 43.3" /></div>
            <div style="display:flex; align-items:end; gap:10px">
              <button id="btnSaveFuel" class="primary" style="width:100%">Save fuel</button>
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <button id="btnNewFuel" type="button">Add new fuel key</button>
            <button id="btnResetLocal" type="button">Reset local edits</button>
          </div>

          <div id="editMsg" class="note" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- Outputs -->
      <div class="card">
        <h3>Outputs (Dials + Columns)</h3>

        <!-- ===== System Schematic (UPDATED - no overlapping arrows) ===== -->
        <div class="barBox" style="margin-top:6px">
          <div class="barTitleRow">
            <div class="barTitle">System schematic (interactive)</div>
            <div class="small">Arrow thickness ∝ flow</div>
          </div>

          <svg id="schem" viewBox="0 0 900 340" style="width:100%; height:auto; display:block">
            <defs>
              <linearGradient id="chGrad" x1="0" x2="1">
                <stop offset="0" stop-color="rgba(255,255,255,.04)"/>
                <stop offset="1" stop-color="rgba(255,255,255,.02)"/>
              </linearGradient>
              <marker id="arrowHead" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 Z" fill="rgba(231,238,252,.9)"></path>
              </marker>
            </defs>

            <!-- Combustor -->
            <rect x="340" y="70" width="240" height="200" rx="18" fill="url(#chGrad)" stroke="rgba(255,255,255,.12)"/>
            <text x="460" y="110" text-anchor="middle" fill="rgba(231,238,252,.95)" font-size="16" font-weight="700">Combustor</text>
            <text id="tPower" x="460" y="135" text-anchor="middle" fill="rgba(167,180,209,.95)" font-size="12">Q̇: —</text>

            <!-- Mixer (moved down slightly) -->
            <rect x="210" y="155" width="90" height="70" rx="14" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.12)"/>
            <text x="255" y="197" text-anchor="middle" fill="rgba(231,238,252,.9)" font-size="12" font-weight="700">Mixer</text>

            <!-- Fuel 1 (curved path to upper inlet) -->
            <path id="f1Line" d="M 40 120 C 120 110, 160 120, 210 170"
                  stroke="rgba(98,168,255,.95)" stroke-width="8" fill="none"
                  stroke-linecap="round" marker-end="url(#arrowHead)"/>
            <text x="40" y="100" fill="rgba(167,180,209,.95)" font-size="12">Fuel 1</text>
            <text id="tF1" x="40" y="135" fill="rgba(231,238,252,.95)" font-size="12">—</text>

            <!-- Fuel 2 (curved path to lower inlet) -->
            <path id="f2Line" d="M 40 280 C 120 290, 160 255, 210 225"
                  stroke="rgba(255,204,102,.90)" stroke-width="8" fill="none"
                  stroke-linecap="round" marker-end="url(#arrowHead)"/>
            <text x="40" y="305" fill="rgba(167,180,209,.95)" font-size="12">Fuel 2</text>
            <text id="tF2" x="40" y="325" fill="rgba(231,238,252,.95)" font-size="12">—</text>

            <!-- Mixer to combustor -->
            <line id="mixLine" x1="300" y1="190" x2="340" y2="190"
                  stroke="rgba(231,238,252,.85)" stroke-width="10" stroke-linecap="round"
                  marker-end="url(#arrowHead)"/>
            <text id="tBlend" x="305" y="175" fill="rgba(167,180,209,.95)" font-size="12">Blend</text>

            <!-- Air -->
            <line id="airLine" x1="460" y1="20" x2="460" y2="70"
                  stroke="rgba(231,238,252,.85)" stroke-width="14" stroke-linecap="round"
                  marker-end="url(#arrowHead)"/>
            <text x="470" y="30" fill="rgba(167,180,209,.95)" font-size="12">Air</text>
            <text id="tAir" x="470" y="50" fill="rgba(231,238,252,.95)" font-size="12">—</text>

            <!-- Exhaust -->
            <line id="exLine" x1="580" y1="190" x2="860" y2="190"
                  stroke="rgba(231,238,252,.55)" stroke-width="12" stroke-linecap="round"
                  marker-end="url(#arrowHead)"/>
            <text x="865" y="175" text-anchor="end" fill="rgba(167,180,209,.95)" font-size="12">Exhaust</text>

            <!-- Inside labels -->
            <text id="tAFR" x="460" y="175" text-anchor="middle" fill="rgba(231,238,252,.9)" font-size="12">AFRact: —</text>
            <text id="tPhi2" x="460" y="195" text-anchor="middle" fill="rgba(231,238,252,.9)" font-size="12">ϕ: —</text>
            <text id="tMdot" x="460" y="220" text-anchor="middle" fill="rgba(167,180,209,.95)" font-size="12">ṁf: — | ṁa: —</text>
          </svg>

          <div class="note">
            Fuel arrows are curved to separate inlets (no overlap). Air and exhaust align with the main stream.
          </div>
        </div>

        <!-- Dials -->
        <div class="dialGrid">
          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">LHV</div>
              <div class="dialValue"><span class="mono" id="gLHV">—</span><span class="dialUnit">MJ/kg</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dLHV" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>20</span><span>50</span></div>
          </div>

          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">Density</div>
              <div class="dialValue"><span class="mono" id="gRho">—</span><span class="dialUnit">kg/m³</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dRho" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>650</span><span>900</span></div>
          </div>

          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">AFRst</div>
              <div class="dialValue"><span class="mono" id="gAFRst">—</span><span class="dialUnit">kg/kg</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dAFR" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>5</span><span>25</span></div>
          </div>

          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">ϕ (needs AFRact)</div>
              <div class="dialValue"><span class="mono" id="gPhi">—</span><span class="dialUnit">—</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dPhi" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>0.2</span><span>2.0</span></div>
          </div>

          <div class="dialCard">
            <div class="dialTop">
              <div class="dialTitle">CO₂ per energy</div>
              <div class="dialValue"><span class="mono" id="gCO2kWh">—</span><span class="dialUnit">g/kWhₜₕ</span></div>
            </div>
            <div class="dialWrap">
              <svg class="dialSvg" viewBox="0 0 200 120">
                <path class="dialTrack" d="M 20 100 A 80 80 0 0 1 180 100"></path>
                <path class="dialProg" id="dCO2kWh" d="M 20 100 A 80 80 0 0 1 180 100"></path>
              </svg>
            </div>
            <div class="dialMinMax"><span>150</span><span>350</span></div>
          </div>
        </div>

        <!-- Columns -->
        <div class="colChart" style="margin-top:12px">
          <div class="colTop">
            <div class="colTitle">Key outputs (columns)</div>
            <div class="colValue"><span class="small">scaled to typical ranges</span></div>
          </div>

          <div class="cols">
            <div>
              <div class="col"><div class="colFill" id="cLHVvol"></div></div>
              <div class="colLbl">LHV MJ/L</div>
              <div class="small" style="text-align:center"><span class="mono" id="bLHVvol">—</span></div>
            </div>

            <div>
              <div class="col"><div class="colFill" id="cCO2"></div></div>
              <div class="colLbl">CO₂ kg/kg</div>
              <div class="small" style="text-align:center"><span class="mono" id="bCO2kgkg">—</span></div>
            </div>

            <div>
              <div class="col"><div class="colFill" id="cH2O"></div></div>
              <div class="colLbl">H₂O kg/kg</div>
              <div class="small" style="text-align:center"><span class="mono" id="bH2Okgkg">—</span></div>
            </div>

            <div>
              <div class="col"><div class="colFill" id="cQair"></div></div>
              <div class="colLbl">q_air MJ/kg air</div>
              <div class="small" style="text-align:center"><span class="mono" id="bQair">—</span></div>
            </div>
          </div>
        </div>

        <!-- Horizontal bars -->
        <div class="barBox">
          <div class="barTitleRow">
            <div class="barTitle">Computed summary (horizontal bars)</div>
            <div class="small">scaled to typical ranges</div>
          </div>

          <div class="barRow">
            <div class="barLbl">Formula</div>
            <div class="barText mono" id="tFormula">—</div>
            <div class="barVal mono"></div>
          </div>

          <div class="barRow">
            <div class="barLbl">MW (g/mol)</div>
            <div class="barTrack"><div class="barFill" id="hbMW"></div></div>
            <div class="barVal mono" id="tMW">—</div>
          </div>

          <div class="barRow">
            <div class="barLbl">νO₂ (mol/mol)</div>
            <div class="barTrack"><div class="barFill" id="hbNuO2"></div></div>
            <div class="barVal mono" id="tNuO2">—</div>
          </div>

          <div class="barRow">
            <div class="barLbl">λ (—)</div>
            <div class="barTrack"><div class="barFill" id="hbLambda"></div></div>
            <div class="barVal mono" id="tLambda">—</div>
          </div>

          <div class="barRow">
            <div class="barLbl">ṁf (kg/s)</div>
            <div class="barTrack"><div class="barFill" id="hbMdotF"></div></div>
            <div class="barVal mono" id="tMdotF">—</div>
          </div>

          <div class="barRow">
            <div class="barLbl">ṁa (kg/s)</div>
            <div class="barTrack"><div class="barFill" id="hbMdotA"></div></div>
            <div class="barVal mono" id="tMdotA">—</div>
          </div>
        </div>

        <div class="note">
          Stoichiometry: νO₂ = x + y/4 − z/2; AFRst uses Y<sub>O2</sub>=0.232 (mass fraction).<br/>
          ϕ = AFRst/AFRact, λ = 1/ϕ, q<sub>air</sub>=LHV/AFRact. Q̇ in MW equals MJ/s.
        </div>
      </div>
    </div>

    <div class="footer">
      <span class="mono">Note:</span> Screening tool for trends; not a substitute for certification testing.
    </div>
  </div>

<script>
  const Y_O2_AIR = 0.232;
  const MW = { C: 12.011, H: 1.008, O: 15.999, O2: 31.998, CO2: 44.0095, H2O: 18.01528 };

  const CAT_ORDER = [
    "Conventional Jet",
    "SAF (Paraffinic)",
    "SAF (Cyclo/Aromatic)",
    "Oxygenated e-fuels (screening)",
    "Pure-component references",
    "Oxygenates (validation)",
    "Diesel/Gasoline (screening)",
    "Gases (stoichiometry checks)",
    "User (local)"
  ];

  const DEFAULT_FUELS = {
    JetA:        { cat:"Conventional Jet", name:"Jet-A (rep)",                  xC:11.40, yH:22.10, zO:0.00, rho:803.0, LHV:43.06 },
    JetA_light:  { cat:"Conventional Jet", name:"Jet-A (lighter cut)",          xC:10.80, yH:21.60, zO:0.00, rho:790.0, LHV:43.20 },
    JetA_heavy:  { cat:"Conventional Jet", name:"Jet-A (heavier cut)",          xC:12.20, yH:23.20, zO:0.00, rho:820.0, LHV:42.90 },
    JetA_hiAro:  { cat:"Conventional Jet", name:"Jet fuel (higher aromatics)",  xC:10.80, yH:17.50, zO:0.00, rho:840.0, LHV:42.00 },
    JetA_loAro:  { cat:"Conventional Jet", name:"Jet fuel (low aromatics)",     xC:11.80, yH:25.50, zO:0.00, rho:770.0, LHV:43.90 },

    HEFA:        { cat:"SAF (Paraffinic)", name:"HEFA-SPK (rep)",               xC:11.60, yH:25.20, zO:0.00, rho:752.0, LHV:44.18 },
    FT:          { cat:"SAF (Paraffinic)", name:"FT-SPK (rep)",                 xC:12.00, yH:26.00, zO:0.00, rho:760.0, LHV:43.50 },
    ATJ:         { cat:"SAF (Paraffinic)", name:"ATJ-SPK (rep)",                xC:11.30, yH:24.80, zO:0.00, rho:760.0, LHV:43.80 },
    SIP:         { cat:"SAF (Paraffinic)", name:"SIP (iso-paraffinic)",         xC:11.00, yH:24.00, zO:0.00, rho:750.0, LHV:44.00 },
    HFS_SPK:     { cat:"SAF (Paraffinic)", name:"HFS (hydroprocessed sugars)",  xC:11.20, yH:24.40, zO:0.00, rho:748.0, LHV:44.10 },

    CHJ:         { cat:"SAF (Cyclo/Aromatic)", name:"CHJ (cycloalkane rich)",        xC:10.80, yH:19.50, zO:0.00, rho:815.0, LHV:42.60 },
    FT_SKA:      { cat:"SAF (Cyclo/Aromatic)", name:"FT-SKA (aromatics-containing)", xC:10.50, yH:16.50, zO:0.00, rho:850.0, LHV:41.80 },
    ARO_05:      { cat:"SAF (Cyclo/Aromatic)", name:"Aromatics surrogate (~5%)",     xC:11.20, yH:21.00, zO:0.00, rho:815.0, LHV:42.90 },
    ARO_10:      { cat:"SAF (Cyclo/Aromatic)", name:"Aromatics surrogate (~10%)",    xC:10.80, yH:19.00, zO:0.00, rho:840.0, LHV:42.20 },
    ARO_20:      { cat:"SAF (Cyclo/Aromatic)", name:"Aromatics surrogate (~20%)",    xC:10.20, yH:16.00, zO:0.00, rho:870.0, LHV:41.20 },

    eKero_O0:    { cat:"Oxygenated e-fuels (screening)", name:"e-Kerosene (no oxygen)",      xC:12.00, yH:26.00, zO:0.00, rho:775.0, LHV:43.80 },
    eKero_O1:    { cat:"Oxygenated e-fuels (screening)", name:"Oxygenated e-kerosene (O~1)", xC:12.00, yH:24.00, zO:1.00, rho:820.0, LHV:41.80 },
    eKero_O2:    { cat:"Oxygenated e-fuels (screening)", name:"Oxygenated e-kerosene (O~2)", xC:12.00, yH:24.00, zO:2.00, rho:840.0, LHV:40.50 },
    eKero_O3:    { cat:"Oxygenated e-fuels (screening)", name:"Oxygenated e-kerosene (O~3)", xC:12.00, yH:24.00, zO:3.00, rho:860.0, LHV:39.20 },

    nDecane:      { cat:"Pure-component references", name:"n-Decane (C10H22)",         xC:10.00, yH:22.00, zO:0.00, rho:730.0, LHV:44.60 },
    nDodecane:    { cat:"Pure-component references", name:"n-Dodecane (C12H26)",       xC:12.00, yH:26.00, zO:0.00, rho:748.0, LHV:44.00 },
    nTetradecane: { cat:"Pure-component references", name:"n-Tetradecane (C14H30)",    xC:14.00, yH:30.00, zO:0.00, rho:763.0, LHV:43.20 },
    isoOctane:    { cat:"Pure-component references", name:"Iso-octane (C8H18)",        xC: 8.00, yH:18.00, zO:0.00, rho:692.0, LHV:44.30 },
    Toluene:      { cat:"Pure-component references", name:"Toluene (C7H8)",            xC: 7.00, yH: 8.00, zO:0.00, rho:867.0, LHV:40.60 },
    Xylene:       { cat:"Pure-component references", name:"Xylene (C8H10)",            xC: 8.00, yH:10.00, zO:0.00, rho:860.0, LHV:40.00 },
    Cyclohexane:  { cat:"Pure-component references", name:"Cyclohexane (C6H12)",       xC: 6.00, yH:12.00, zO:0.00, rho:779.0, LHV:43.30 },

    MeOH:         { cat:"Oxygenates (validation)", name:"Methanol (CH4O)",             xC: 1.00, yH: 4.00, zO:1.00, rho:792.0, LHV:19.90 },
    EtOH:         { cat:"Oxygenates (validation)", name:"Ethanol (C2H6O)",             xC: 2.00, yH: 6.00, zO:1.00, rho:789.0, LHV:26.80 },
    iPrOH:        { cat:"Oxygenates (validation)", name:"Isopropanol (C3H8O)",         xC: 3.00, yH: 8.00, zO:1.00, rho:786.0, LHV:30.00 },
    BuOH:         { cat:"Oxygenates (validation)", name:"n-Butanol (C4H10O)",          xC: 4.00, yH:10.00, zO:1.00, rho:810.0, LHV:33.10 },
    MTBE:         { cat:"Oxygenates (validation)", name:"MTBE (C5H12O)",               xC: 5.00, yH:12.00, zO:1.00, rho:740.0, LHV:35.00 },

    Gasoline:     { cat:"Diesel/Gasoline (screening)", name:"Gasoline surrogate",      xC: 8.00, yH:18.00, zO:0.00, rho:740.0, LHV:43.50 },
    Diesel:       { cat:"Diesel/Gasoline (screening)", name:"Diesel surrogate",        xC:14.00, yH:30.00, zO:0.00, rho:835.0, LHV:42.70 },

    CH4:          { cat:"Gases (stoichiometry checks)", name:"Methane (gas, ref)",         xC: 1.00, yH: 4.00, zO:0.00, rho:  0.656, LHV:50.00 },
    LCH4:         { cat:"Gases (stoichiometry checks)", name:"Liquid methane (cryogenic)", xC: 1.00, yH: 4.00, zO:0.00, rho:420.0,  LHV:50.00 },
    C3H8:         { cat:"Gases (stoichiometry checks)", name:"Propane (gas, ref)",         xC: 3.00, yH: 8.00, zO:0.00, rho:  1.88,  LHV:46.40 },
    H2:           { cat:"Gases (stoichiometry checks)", name:"Hydrogen (gas, ref)",        xC: 0.00, yH: 2.00, zO:0.00, rho:  0.084, LHV:120.0 }
  };

  const FUELS = JSON.parse(JSON.stringify(DEFAULT_FUELS));
  try {
    const saved = localStorage.getItem("fuelsim_fuels");
    if (saved) {
      const obj = JSON.parse(saved);
      for (const k of Object.keys(obj)) FUELS[k] = obj[k];
    }
  } catch(e) {}

  function saveLocalFuels(){ try { localStorage.setItem("fuelsim_fuels", JSON.stringify(FUELS)); } catch(e) {} }
  function resetLocalFuels(){
    try { localStorage.removeItem("fuelsim_fuels"); } catch(e) {}
    for (const k of Object.keys(FUELS)) delete FUELS[k];
    for (const k of Object.keys(DEFAULT_FUELS)) FUELS[k] = JSON.parse(JSON.stringify(DEFAULT_FUELS[k]));
  }

  function mwFuel(f) { return f.xC*MW.C + f.yH*MW.H + f.zO*MW.O; }
  function nuO2Stoich(f) { return f.xC + f.yH/4.0 - f.zO/2.0; }
  function afrStoichMass(f) {
    const nu = nuO2Stoich(f);
    if (nu <= 0) throw new Error("Non-physical stoichiometric O2 requirement.");
    const mwf = mwFuel(f);
    if (mwf <= 0) throw new Error("Non-physical fuel molecular weight.");
    const mO2 = nu * MW.O2;
    return mO2 / (mwf * Y_O2_AIR);
  }
  function co2IntensityKgPerKg(f){
    const mwf = mwFuel(f);
    if (mwf <= 0) throw new Error("Non-physical fuel molecular weight.");
    return (f.xC * MW.CO2) / mwf;
  }
  function h2oIntensityKgPerKg(f){
    const mwf = mwFuel(f);
    if (mwf <= 0) throw new Error("Non-physical fuel molecular weight.");
    return ((f.yH/2.0) * MW.H2O) / mwf;
  }
  function co2PerKWhth_g(f){
    const co2kgkg = co2IntensityKgPerKg(f);
    if (f.LHV <= 0) throw new Error("Non-physical LHV.");
    const kg_per_MJ = co2kgkg / f.LHV;
    return kg_per_MJ * 3.6 * 1000.0;
  }

  function blendMass2(fA, fB, wA) {
    const wB = 1 - wA;
    const LHV = wA*fA.LHV + wB*fB.LHV;
    const invRho = (wA / fA.rho) + (wB / fB.rho);
    const rho = 1 / invRho;
    const xC = wA*fA.xC + wB*fB.xC;
    const yH = wA*fA.yH + wB*fB.yH;
    const zO = wA*fA.zO + wB*fB.zO;
    return { name:"", xC, yH, zO, rho, LHV };
  }

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function fmt(x, n=3){ return Number(x).toFixed(n); }
  function showWarn(el, msg){
    if (!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="block"; el.textContent = msg;
  }

  function setDial(pathEl, value, vmin, vmax){
    if (!pathEl) return;
    if (!Number.isFinite(value)) { pathEl.style.strokeDasharray = "0 9999"; return; }
    const p = clamp01((value - vmin) / (vmax - vmin));
    const arc = 251;
    pathEl.style.strokeDasharray = `${(p*arc).toFixed(1)} 9999`;
  }

  function setCol(el, value, vmin, vmax){
    if (!el) return;
    if (!Number.isFinite(value)) { el.style.height = "0%"; return; }
    const p = clamp01((value - vmin) / (vmax - vmin));
    el.style.height = (p*100).toFixed(1) + "%";
  }

  function setHBar(el, value, vmin, vmax){
    if (!el) return;
    if (!Number.isFinite(value)) { el.style.width = "0%"; return; }
    const p = clamp01((value - vmin) / (vmax - vmin));
    el.style.width = (p*100).toFixed(1) + "%";
  }

  // Works for both <line> and <path>
  function updateSchematic({wA, wB, afr_act, afr_st, phi, qMW, mdot_f, mdot_a, fuelAKey, fuelBKey}) {
    const f1 = document.getElementById("f1Line");
    const f2 = document.getElementById("f2Line");
    const mix = document.getElementById("mixLine");
    const air = document.getElementById("airLine");
    const ex  = document.getElementById("exLine");

    const tF1 = document.getElementById("tF1");
    const tF2 = document.getElementById("tF2");
    const tAir= document.getElementById("tAir");
    const tAFR= document.getElementById("tAFR");
    const tPhi= document.getElementById("tPhi2");
    const tPow= document.getElementById("tPower");
    const tMd = document.getElementById("tMdot");
    const tBlend = document.getElementById("tBlend");

    const baseFuel = 6;
    const spanFuel = 12;
    const w1 = baseFuel + spanFuel * wA;
    const w2 = baseFuel + spanFuel * wB;

    let wMix = (w1 + w2) * 0.6;

    let
