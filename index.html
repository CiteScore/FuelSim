<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fuel Blend Calculator (Mass %)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --card2:#0f1726; --text:#e7eefc; --muted:#a7b4d1;
      --line:rgba(255,255,255,.10); --accent:#62a8ff; --warn:#ffcc66;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#070c16);color:var(--text)}
    .wrap{max-width:1020px;margin:0 auto;padding:24px}
    .topbar{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .title{font-size:20px;font-weight:700;margin:0}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{background:rgba(18,26,43,.92);border:1px solid var(--line);border-radius:14px;padding:16px}
    .card h3{margin:0 0 10px;font-size:14px;letter-spacing:.2px;color:#d8e4ff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    select,input[type="text"]{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:var(--card2);color:var(--text);outline:none
    }
    input[type="range"]{width:100%}
    .sliderline{display:flex;align-items:center;gap:10px}
    .pill{
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.04);
      font-size:12px;color:var(--text);min-width:110px;text-align:center
    }
    .note{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.45}
    .warn{
      margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,204,102,.35);
      background:rgba(255,204,102,.08);color:var(--warn);font-size:12px;line-height:1.45;display:none
    }
    .footer{margin-top:14px;color:var(--muted);font-size:11px}
    .small{font-size:11px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    button{
      padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);cursor:pointer
    }
    button.primary{background:rgba(98,168,255,.18)}

    /* ---- Output visual widgets ---- */
    .outGrid{display:grid;grid-template-columns:1fr;gap:14px}

    .gauges{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:520px){ .gauges{grid-template-columns:1fr} }

    .gaugeCard{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:12px}
    .gaugeTop{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .gaugeTitle{font-size:12px;color:var(--muted)}
    .gaugeValue{font-size:14px;font-weight:700}
    .gaugeUnit{font-size:11px;color:var(--muted);margin-left:6px}
    .gaugeTrack{height:10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--line);overflow:hidden;margin-top:10px}
    .gaugeFill{height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg,rgba(98,168,255,.30),rgba(98,168,255,.95))}
    .gaugeMinMax{display:flex;justify-content:space-between;margin-top:6px;color:var(--muted);font-size:11px}

    .bars{display:grid;grid-template-columns:1fr;gap:10px}
    .barRow{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:12px}
    .barTop{display:flex;justify-content:space-between;align-items:baseline;gap:10px}
    .barTitle{font-size:12px;color:var(--muted)}
    .barValue{font-size:14px;font-weight:700}
    .barTrack{height:12px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid var(--line);overflow:hidden;margin-top:10px}
    .barFill{height:100%;width:0%;border-radius:10px;background:linear-gradient(90deg,rgba(255,204,102,.25),rgba(255,204,102,.95))}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <p class="title">Fuel Blend Calculator</p>
        <p class="subtitle">
          Two-component blending by <b>mass %</b>. Live outputs: density, LHV, surrogate formula, stoichiometry, and sizing metrics.
        </p>
      </div>
      <div class="small">
        Basis: <b>mass%</b> (A + B = 100)
        <div class="footer">Screening tool: transparent assumptions, trend-focused.</div>
      </div>
    </div>

    <div class="grid">
      <!-- Inputs -->
      <div class="card">
        <h3>Inputs</h3>

        <label for="fuelSearch">Search fuels (key or name)</label>
        <input id="fuelSearch" type="text" placeholder="Type to filter dropdowns (e.g., HEFA, aromatic, ethanol, methane...)" />

        <div class="row" style="margin-top:8px">
          <div>
            <label for="fuelA">Fuel A</label>
            <select id="fuelA"></select>
          </div>
          <div>
            <label for="fuelB">Fuel B</label>
            <select id="fuelB"></select>
          </div>
        </div>

        <label>Blend ratio (mass %)</label>
        <div class="sliderline">
          <div class="pill" id="pillA">A: 70%</div>
          <input id="massA" type="range" min="0" max="100" step="1" value="70" />
          <div class="pill" id="pillB">B: 30%</div>
        </div>

        <label for="blendName">Optional blend name</label>
        <input id="blendName" type="text" placeholder="Leave blank for auto-name" />

        <!-- Bundle 2/3 additional operating inputs -->
        <div style="margin-top:14px; padding:12px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
            <div style="font-weight:700; font-size:12px; color:#d8e4ff">Operating inputs (optional)</div>
            <div class="small">Enable φ, λ, sizing</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="afrAct">Actual AFR (kg air / kg fuel)</label>
              <input id="afrAct" type="text" placeholder="Leave blank to skip (e.g., 18.0)" />
            </div>
            <div>
              <label for="qthMW">Target thermal power Q̇ (MWₜₕ)</label>
              <input id="qthMW" type="text" placeholder="Leave blank to skip (e.g., 10)" />
            </div>
          </div>

          <div class="note">
            If you provide <b>Actual AFR</b>, the tool computes equivalence ratio φ and excess-air λ.<br/>
            If you also provide <b>Q̇</b>, the tool computes fuel/air mass flow rates.
          </div>
        </div>

        <div class="note">
          <b>Reference density field:</b> uses each fuel’s stated reference density (often 15°C for liquids; cryogenic for LCH₄).<br/>
          Mixing uses specific-volume rule (engineering approximation).
        </div>

        <div class="warn" id="warnBox"></div>

        <!-- Editable Fuel Properties (browser-local) -->
        <div style="margin-top:14px; padding:12px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.03)">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
            <div style="font-weight:700; font-size:12px; color:#d8e4ff">Edit / Add Fuel</div>
            <div class="small">Saved locally in this browser</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="editKey">Fuel key to edit</label>
              <select id="editKey"></select>
            </div>
            <div>
              <label for="editName">Fuel name</label>
              <input id="editName" type="text" placeholder="Display name" />
            </div>
          </div>

          <div class="row">
            <div><label for="editXC">xC</label><input id="editXC" type="text" placeholder="e.g., 12" /></div>
            <div><label for="editYH">yH</label><input id="editYH" type="text" placeholder="e.g., 26" /></div>
          </div>

          <div class="row">
            <div><label for="editZO">zO</label><input id="editZO" type="text" placeholder="e.g., 0" /></div>
            <div><label for="editRho">Density ρ (kg/m³)</label><input id="editRho" type="text" placeholder="e.g., 780" /></div>
          </div>

          <div class="row">
            <div><label for="editLHV">LHV (MJ/kg)</label><input id="editLHV" type="text" placeholder="e.g., 43.3" /></div>
            <div style="display:flex; align-items:end; gap:10px">
              <button id="btnSaveFuel" class="primary" style="width:100%">Save fuel</button>
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <button id="btnNewFuel">Add new fuel key</button>
            <button id="btnResetLocal">Reset local edits</button>
          </div>

          <div id="editMsg" class="note" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- Outputs (Visual) -->
      <div class="card">
        <h3>Outputs (Visual)</h3>

        <div class="outGrid">
          <!-- Gauges -->
          <div class="gauges">
            <div class="gaugeCard">
              <div class="gaugeTop">
                <div class="gaugeTitle">LHV</div>
                <div class="gaugeValue"><span class="mono" id="gLHV">—</span><span class="gaugeUnit">MJ/kg</span></div>
              </div>
              <div class="gaugeTrack"><div class="gaugeFill" id="gLHVFill"></div></div>
              <div class="gaugeMinMax"><span>20</span><span>50</span></div>
            </div>

            <div class="gaugeCard">
              <div class="gaugeTop">
                <div class="gaugeTitle">Density</div>
                <div class="gaugeValue"><span class="mono" id="gRho">—</span><span class="gaugeUnit">kg/m³</span></div>
              </div>
              <div class="gaugeTrack"><div class="gaugeFill" id="gRhoFill"></div></div>
              <div class="gaugeMinMax"><span>650</span><span>900</span></div>
            </div>

            <div class="gaugeCard">
              <div class="gaugeTop">
                <div class="gaugeTitle">AFRst</div>
                <div class="gaugeValue"><span class="mono" id="gAFRst">—</span><span class="gaugeUnit">kg/kg</span></div>
              </div>
              <div class="gaugeTrack"><div class="gaugeFill" id="gAFRFill"></div></div>
              <div class="gaugeMinMax"><span>5</span><span>25</span></div>
            </div>

            <div class="gaugeCard">
              <div class="gaugeTop">
                <div class="gaugeTitle">ϕ (needs AFRact)</div>
                <div class="gaugeValue"><span class="mono" id="gPhi">—</span><span class="gaugeUnit">—</span></div>
              </div>
              <div class="gaugeTrack"><div class="gaugeFill" id="gPhiFill"></div></div>
              <div class="gaugeMinMax"><span>0.2</span><span>2.0</span></div>
            </div>

            <div class="gaugeCard">
              <div class="gaugeTop">
                <div class="gaugeTitle">CO₂ per energy</div>
                <div class="gaugeValue"><span class="mono" id="gCO2kWh">—</span><span class="gaugeUnit">g/kWhₜₕ</span></div>
              </div>
              <div class="gaugeTrack"><div class="gaugeFill" id="gCO2kWhFill"></div></div>
              <div class="gaugeMinMax"><span>150</span><span>350</span></div>
            </div>
          </div>

          <!-- Bars -->
          <div class="bars">
            <div class="barRow">
              <div class="barTop">
                <div class="barTitle">LHV (volumetric)</div>
                <div class="barValue"><span class="mono" id="bLHVvol">—</span> <span class="gaugeUnit">MJ/L</span></div>
              </div>
              <div class="barTrack"><div class="barFill" id="bLHVvolFill"></div></div>
            </div>

            <div class="barRow">
              <div class="barTop">
                <div class="barTitle">CO₂ intensity</div>
                <div class="barValue"><span class="mono" id="bCO2kgkg">—</span> <span class="gaugeUnit">kg/kg</span></div>
              </div>
              <div class="barTrack"><div class="barFill" id="bCO2Fill"></div></div>
            </div>

            <div class="barRow">
              <div class="barTop">
                <div class="barTitle">H₂O intensity</div>
                <div class="barValue"><span class="mono" id="bH2Okgkg">—</span> <span class="gaugeUnit">kg/kg</span></div>
              </div>
              <div class="barTrack"><div class="barFill" id="bH2OFill"></div></div>
            </div>

            <div class="barRow">
              <div class="barTop">
                <div class="barTitle">Heat per kg air (needs AFRact)</div>
                <div class="barValue"><span class="mono" id="bQair">—</span> <span class="gaugeUnit">MJ/kg air</span></div>
              </div>
              <div class="barTrack"><div class="barFill" id="bQairFill"></div></div>
            </div>
          </div>

          <div class="note">
            Formula: <span class="mono" id="tFormula">—</span> |
            MW: <span class="mono" id="tMW">—</span> g/mol |
            νO₂: <span class="mono" id="tNuO2">—</span> mol/mol |
            λ: <span class="mono" id="tLambda">—</span> |
            ṁf: <span class="mono" id="tMdotF">—</span> kg/s |
            ṁa: <span class="mono" id="tMdotA">—</span> kg/s
          </div>

          <div class="note">
            Definitions (screening): νO₂ = x + y/4 − z/2; AFRst uses Y<sub>O2</sub>=0.232 (mass fraction).<br/>
            CO₂/kg fuel = x·MW(CO₂)/MW(fuel); H₂O/kg fuel = (y/2)·MW(H₂O)/MW(fuel).<br/>
            ϕ = AFRst/AFRact, λ = 1/ϕ, q<sub>air</sub>=LHV/AFRact. Q̇ in MW equals MJ/s.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <span class="mono">Note:</span> This tool is intended for engineering screening and relative trends. It does not replace certification testing.
    </div>
  </div>

<script>
  // ---- Constants (engineering approximations)
  const Y_O2_AIR = 0.232;
  const MW = { C: 12.011, H: 1.008, O: 15.999, O2: 31.998, CO2: 44.0095, H2O: 18.01528 };

  // ---- Category order for dropdown grouping
  const CAT_ORDER = [
    "Conventional Jet",
    "SAF (Paraffinic)",
    "SAF (Cyclo/Aromatic)",
    "Oxygenated e-fuels (screening)",
    "Pure-component references",
    "Oxygenates (validation)",
    "Diesel/Gasoline (screening)",
    "Gases (stoichiometry checks)",
    "User (local)"
  ];

  // ---- Default fuel database (screening surrogates)
  const DEFAULT_FUELS = {
    // Conventional / baseline
    JetA:        { cat:"Conventional Jet", name:"Jet-A (rep)",                  xC:11.40, yH:22.10, zO:0.00, rho:803.0, LHV:43.06 },
    JetA_light:  { cat:"Conventional Jet", name:"Jet-A (lighter cut)",          xC:10.80, yH:21.60, zO:0.00, rho:790.0, LHV:43.20 },
    JetA_heavy:  { cat:"Conventional Jet", name:"Jet-A (heavier cut)",          xC:12.20, yH:23.20, zO:0.00, rho:820.0, LHV:42.90 },
    JetA_hiAro:  { cat:"Conventional Jet", name:"Jet fuel (higher aromatics)",  xC:10.80, yH:17.50, zO:0.00, rho:840.0, LHV:42.00 },
    JetA_loAro:  { cat:"Conventional Jet", name:"Jet fuel (low aromatics)",     xC:11.80, yH:25.50, zO:0.00, rho:770.0, LHV:43.90 },

    // SAF families (paraffinic)
    HEFA:        { cat:"SAF (Paraffinic)", name:"HEFA-SPK (rep)",               xC:11.60, yH:25.20, zO:0.00, rho:752.0, LHV:44.18 },
    FT:          { cat:"SAF (Paraffinic)", name:"FT-SPK (rep)",                 xC:12.00, yH:26.00, zO:0.00, rho:760.0, LHV:43.50 },
    ATJ:         { cat:"SAF (Paraffinic)", name:"ATJ-SPK (rep)",                xC:11.30, yH:24.80, zO:0.00, rho:760.0, LHV:43.80 },
    SIP:         { cat:"SAF (Paraffinic)", name:"SIP (iso-paraffinic)",         xC:11.00, yH:24.00, zO:0.00, rho:750.0, LHV:44.00 },
    HFS_SPK:     { cat:"SAF (Paraffinic)", name:"HFS (hydroprocessed sugars)",  xC:11.20, yH:24.40, zO:0.00, rho:748.0, LHV:44.10 },

    // SAF with aromatics / cycloalkanes
    CHJ:         { cat:"SAF (Cyclo/Aromatic)", name:"CHJ (cycloalkane rich)",        xC:10.80, yH:19.50, zO:0.00, rho:815.0, LHV:42.60 },
    FT_SKA:      { cat:"SAF (Cyclo/Aromatic)", name:"FT-SKA (aromatics-containing)", xC:10.50, yH:16.50, zO:0.00, rho:850.0, LHV:41.80 },
    ARO_05:      { cat:"SAF (Cyclo/Aromatic)", name:"Aromatics surrogate (~5%)",     xC:11.20, yH:21.00, zO:0.00, rho:815.0, LHV:42.90 },
    ARO_10:      { cat:"SAF (Cyclo/Aromatic)", name:"Aromatics surrogate (~10%)",    xC:10.80, yH:19.00, zO:0.00, rho:840.0, LHV:42.20 },
    ARO_20:      { cat:"SAF (Cyclo/Aromatic)", name:"Aromatics surrogate (~20%)",    xC:10.20, yH:16.00, zO:0.00, rho:870.0, LHV:41.20 },

    // Oxygenated screening surrogates (not drop-in jet)
    eKero_O0:    { cat:"Oxygenated e-fuels (screening)", name:"e-Kerosene (no oxygen)",      xC:12.00, yH:26.00, zO:0.00, rho:775.0, LHV:43.80 },
    eKero_O1:    { cat:"Oxygenated e-fuels (screening)", name:"Oxygenated e-kerosene (O~1)", xC:12.00, yH:24.00, zO:1.00, rho:820.0, LHV:41.80 },
    eKero_O2:    { cat:"Oxygenated e-fuels (screening)", name:"Oxygenated e-kerosene (O~2)", xC:12.00, yH:24.00, zO:2.00, rho:840.0, LHV:40.50 },
    eKero_O3:    { cat:"Oxygenated e-fuels (screening)", name:"Oxygenated e-kerosene (O~3)", xC:12.00, yH:24.00, zO:3.00, rho:860.0, LHV:39.20 },

    // Pure-component references
    nDecane:      { cat:"Pure-component references", name:"n-Decane (C10H22)",         xC:10.00, yH:22.00, zO:0.00, rho:730.0, LHV:44.60 },
    nDodecane:    { cat:"Pure-component references", name:"n-Dodecane (C12H26)",       xC:12.00, yH:26.00, zO:0.00, rho:748.0, LHV:44.00 },
    nTetradecane: { cat:"Pure-component references", name:"n-Tetradecane (C14H30)",    xC:14.00, yH:30.00, zO:0.00, rho:763.0, LHV:43.20 },
    isoOctane:    { cat:"Pure-component references", name:"Iso-octane (C8H18)",        xC: 8.00, yH:18.00, zO:0.00, rho:692.0, LHV:44.30 },
    Toluene:      { cat:"Pure-component references", name:"Toluene (C7H8)",            xC: 7.00, yH: 8.00, zO:0.00, rho:867.0, LHV:40.60 },
    Xylene:       { cat:"Pure-component references", name:"Xylene (C8H10)",            xC: 8.00, yH:10.00, zO:0.00, rho:860.0, LHV:40.00 },
    Cyclohexane:  { cat:"Pure-component references", name:"Cyclohexane (C6H12)",       xC: 6.00, yH:12.00, zO:0.00, rho:779.0, LHV:43.30 },

    // Oxygenates / alcohols (validation)
    MeOH:         { cat:"Oxygenates (validation)", name:"Methanol (CH4O)",             xC: 1.00, yH: 4.00, zO:1.00, rho:792.0, LHV:19.90 },
    EtOH:         { cat:"Oxygenates (validation)", name:"Ethanol (C2H6O)",             xC: 2.00, yH: 6.00, zO:1.00, rho:789.0, LHV:26.80 },
    iPrOH:        { cat:"Oxygenates (validation)", name:"Isopropanol (C3H8O)",         xC: 3.00, yH: 8.00, zO:1.00, rho:786.0, LHV:30.00 },
    BuOH:         { cat:"Oxygenates (validation)", name:"n-Butanol (C4H10O)",          xC: 4.00, yH:10.00, zO:1.00, rho:810.0, LHV:33.10 },
    MTBE:         { cat:"Oxygenates (validation)", name:"MTBE (C5H12O)",               xC: 5.00, yH:12.00, zO:1.00, rho:740.0, LHV:35.00 },

    // Diesel / gasoline screening
    Gasoline:     { cat:"Diesel/Gasoline (screening)", name:"Gasoline surrogate",      xC: 8.00, yH:18.00, zO:0.00, rho:740.0, LHV:43.50 },
    Diesel:       { cat:"Diesel/Gasoline (screening)", name:"Diesel surrogate",        xC:14.00, yH:30.00, zO:0.00, rho:835.0, LHV:42.70 },

    // Gases (stoich checks)
    CH4:          { cat:"Gases (stoichiometry checks)", name:"Methane (gas, ref)",     xC: 1.00, yH: 4.00, zO:0.00, rho:  0.656, LHV:50.00 },
    LCH4:         { cat:"Gases (stoichiometry checks)", name:"Liquid methane (cryogenic)", xC:1.00, yH:4.00, zO:0.00, rho:420.0, LHV:50.00 },
    C3H8:         { cat:"Gases (stoichiometry checks)", name:"Propane (gas, ref)",     xC: 3.00, yH: 8.00, zO:0.00, rho:  1.88,  LHV:46.40 },
    H2:           { cat:"Gases (stoichiometry checks)", name:"Hydrogen (gas, ref)",    xC: 0.00, yH: 2.00, zO:0.00, rho:  0.084, LHV:120.0 }
  };

  // ---- Working database (defaults + browser-local overrides)
  const FUELS = JSON.parse(JSON.stringify(DEFAULT_FUELS));
  try {
    const saved = localStorage.getItem("fuelsim_fuels");
    if (saved) {
      const obj = JSON.parse(saved);
      for (const k of Object.keys(obj)) FUELS[k] = obj[k];
    }
  } catch(e) {}

  function saveLocalFuels(){
    try { localStorage.setItem("fuelsim_fuels", JSON.stringify(FUELS)); } catch(e) {}
  }
  function resetLocalFuels(){
    try { localStorage.removeItem("fuelsim_fuels"); } catch(e) {}
    for (const k of Object.keys(FUELS)) delete FUELS[k];
    for (const k of Object.keys(DEFAULT_FUELS)) FUELS[k] = JSON.parse(JSON.stringify(DEFAULT_FUELS[k]));
  }

  // ---- Chemistry helpers
  function mwFuel(f) { return f.xC*MW.C + f.yH*MW.H + f.zO*MW.O; } // g/mol
  function nuO2Stoich(f) { return f.xC + f.yH/4.0 - f.zO/2.0; }   // mol O2 per mol fuel
  function afrStoichMass(f) {
    const nu = nuO2Stoich(f);
    if (nu <= 0) throw new Error("Non-physical stoichiometric O2 requirement.");
    const mwf = mwFuel(f);
    if (mwf <= 0) throw new Error("Non-physical fuel molecular weight.");
    const mO2 = nu * MW.O2; // g O2 per mol fuel
    return mO2 / (mwf * Y_O2_AIR); // kg_air/kg_fuel (ratio)
  }
  function co2IntensityKgPerKg(f){
    const mwf = mwFuel(f);
    if (mwf <= 0) throw new Error("Non-physical fuel molecular weight.");
    return (f.xC * MW.CO2) / mwf; // kg/kg (since g/g)
  }
  function h2oIntensityKgPerKg(f){
    const mwf = mwFuel(f);
    if (mwf <= 0) throw new Error("Non-physical fuel molecular weight.");
    return ((f.yH/2.0) * MW.H2O) / mwf; // kg/kg
  }
  function co2PerKWhth_g(f){
    // (kg CO2/kg fuel) / (MJ/kg fuel) -> kg/MJ ; then g/kWh_th
    const co2kgkg = co2IntensityKgPerKg(f);
    if (f.LHV <= 0) throw new Error("Non-physical LHV.");
    const kg_per_MJ = co2kgkg / f.LHV;
    const kg_per_kWh = kg_per_MJ * 3.6;
    return kg_per_kWh * 1000.0;
  }

  // ---- Mass% blend (two components)
  function blendMass2(fA, fB, wA) {
    const wB = 1 - wA;
    const LHV = wA*fA.LHV + wB*fB.LHV;
    const invRho = (wA / fA.rho) + (wB / fB.rho);
    const rho = 1 / invRho;
    const xC = wA*fA.xC + wB*fB.xC;
    const yH = wA*fA.yH + wB*fB.yH;
    const zO = wA*fA.zO + wB*fB.zO;
    return { name:"", xC, yH, zO, rho, LHV };
  }

  // ---- Visual helpers
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function setFill(el, value, vmin, vmax){
    if (!el) return;
    if (!Number.isFinite(value)) { el.style.width = "0%"; return; }
    const p = clamp01((value - vmin) / (vmax - vmin));
    el.style.width = (p*100).toFixed(1) + "%";
  }

  // ---- UI elements
  const elFuelSearch = document.getElementById("fuelSearch");
  const elFuelA = document.getElementById("fuelA");
  const elFuelB = document.getElementById("fuelB");
  const elMassA = document.getElementById("massA");
  const elPillA = document.getElementById("pillA");
  const elPillB = document.getElementById("pillB");
  const elName  = document.getElementById("blendName");
  const elAfrAct = document.getElementById("afrAct");
  const elQthMW  = document.getElementById("qthMW");
  const warnBox = document.getElementById("warnBox");

  // Visual outputs
  const gLHV = document.getElementById("gLHV");
  const gLHVFill = document.getElementById("gLHVFill");
  const gRho = document.getElementById("gRho");
  const gRhoFill = document.getElementById("gRhoFill");
  const gAFRst = document.getElementById("gAFRst");
  const gAFRFill = document.getElementById("gAFRFill");
  const gPhi = document.getElementById("gPhi");
  const gPhiFill = document.getElementById("gPhiFill");
  const gCO2kWh = document.getElementById("gCO2kWh");
  const gCO2kWhFill = document.getElementById("gCO2kWhFill");

  const bLHVvol = document.getElementById("bLHVvol");
  const bLHVvolFill = document.getElementById("bLHVvolFill");
  const bCO2kgkg = document.getElementById("bCO2kgkg");
  const bCO2Fill = document.getElementById("bCO2Fill");
  const bH2Okgkg = document.getElementById("bH2Okgkg");
  const bH2OFill = document.getElementById("bH2OFill");
  const bQair = document.getElementById("bQair");
  const bQairFill = document.getElementById("bQairFill");

  // Compact text
  const tFormula = document.getElementById("tFormula");
  const tMW = document.getElementById("tMW");
  const tNuO2 = document.getElementById("tNuO2");
  const tLambda = document.getElementById("tLambda");
  const tMdotF = document.getElementById("tMdotF");
  const tMdotA = document.getElementById("tMdotA");

  function fmt(x, n=3){ return Number(x).toFixed(n); }
  function showWarn(msg){
    if (!msg){ warnBox.style.display="none"; warnBox.textContent=""; return; }
    warnBox.style.display="block";
    warnBox.textContent = msg;
  }

  function fuelKeys(){ return Object.keys(FUELS).sort(); }
  function getCategory(k){
    const f = FUELS[k];
    if (!f) return "Unknown";
    if (!f.cat) return "User (local)";
    return f.cat;
  }
  function matchesFilter(k, filter){
    if (!filter) return true;
    const f = FUELS[k];
    const t = filter.toLowerCase().trim();
    const hay = (k + " " + (f?.name||"") + " " + (f?.cat||"")).toLowerCase();
    return hay.includes(t);
  }

  function rebuildDropdownGrouped(sel, keepValue, filterText){
    const prev = keepValue ?? sel.value;
    sel.innerHTML = "";

    const keys = fuelKeys().filter(k => matchesFilter(k, filterText));
    const byCat = new Map();
    for (const k of keys) {
      const cat = getCategory(k);
      if (!byCat.has(cat)) byCat.set(cat, []);
      byCat.get(cat).push(k);
    }

    let added = 0;
    for (const cat of CAT_ORDER) {
      const arr = byCat.get(cat);
      if (!arr || arr.length === 0) continue;
      const og = document.createElement("optgroup");
      og.label = cat;
      for (const k of arr) {
        const f = FUELS[k];
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = `${k} — ${f.name}`;
        og.appendChild(opt);
        added++;
      }
      sel.appendChild(og);
    }
    for (const [cat, arr] of byCat.entries()) {
      if (CAT_ORDER.includes(cat)) continue;
      const og = document.createElement("optgroup");
      og.label = cat;
      for (const k of arr) {
        const f = FUELS[k];
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = `${k} — ${f.name}`;
        og.appendChild(opt);
        added++;
      }
      sel.appendChild(og);
    }

    if (added === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No matches";
      opt.disabled = true;
      opt.selected = true;
      sel.appendChild(opt);
      return;
    }

    if (prev && FUELS[prev] && keys.includes(prev)) sel.value = prev;
    else sel.value = keys[0];
  }

  // ---- Editor wiring
  const elEditKey  = document.getElementById("editKey");
  const elEditName = document.getElementById("editName");
  const elEditXC   = document.getElementById("editXC");
  const elEditYH   = document.getElementById("editYH");
  const elEditZO   = document.getElementById("editZO");
  const elEditRho  = document.getElementById("editRho");
  const elEditLHV  = document.getElementById("editLHV");
  const elEditMsg  = document.getElementById("editMsg");

  function loadEditorFromKey(k){
    const f = FUELS[k];
    if (!f) return;
    elEditName.value = f.name ?? k;
    elEditXC.value = f.xC;
    elEditYH.value = f.yH;
    elEditZO.value = f.zO;
    elEditRho.value = f.rho;
    elEditLHV.value = f.LHV;
  }

  function refreshAllDropdowns(){
    const filterText = elFuelSearch.value || "";
    const a = elFuelA.value || "JetA";
    const b = elFuelB.value || "HEFA";
    const e = elEditKey.value || "JetA";

    rebuildDropdownGrouped(elFuelA, a, filterText);
    rebuildDropdownGrouped(elFuelB, b, filterText);
    rebuildDropdownGrouped(elEditKey, e, filterText);

    if (elFuelA.value && elFuelB.value && elFuelA.value === elFuelB.value) {
      const keys = fuelKeys().filter(k => matchesFilter(k, filterText));
      const alt = keys.find(x => x !== elFuelA.value);
      if (alt) elFuelB.value = alt;
    }

    if (elEditKey.value) loadEditorFromKey(elEditKey.value);
    update();
  }

  document.getElementById("btnSaveFuel").addEventListener("click", () => {
    const k = (elEditKey.value || "").trim();
    if (!k) { elEditMsg.textContent = "Error: choose a fuel key."; return; }

    const name = elEditName.value.trim() || k;
    const xC = parseFloat(elEditXC.value);
    const yH = parseFloat(elEditYH.value);
    const zO = parseFloat(elEditZO.value);
    const rho = parseFloat(elEditRho.value);
    const LHV = parseFloat(elEditLHV.value);

    if (![xC,yH,zO,rho,LHV].every(v => Number.isFinite(v))) {
      elEditMsg.textContent = "Error: numeric fields must be valid numbers.";
      return;
    }
    if (xC < 0 || yH < 0 || zO < 0 || rho <= 0 || LHV <= 0) {
      elEditMsg.textContent = "Error: non-physical values (check rho/LHV and x/y/z).";
      return;
    }

    const existing = FUELS[k] || {};
    const cat = existing.cat || "User (local)";

    FUELS[k] = { cat, name, xC, yH, zO, rho, LHV };
    saveLocalFuels();
    elEditMsg.textContent = `Saved '${k}'. (Stored locally in this browser.)`;
    refreshAllDropdowns();
  });

  document.getElementById("btnNewFuel").addEventListener("click", () => {
    const newKey = prompt("Enter new fuel key (e.g., eKero):");
    if (!newKey) return;
    const k = newKey.trim();
    if (!k) return;

    if (!FUELS[k]) {
      FUELS[k] = { cat:"User (local)", name:k, xC:12, yH:26, zO:0, rho:780, LHV:43.3 };
      saveLocalFuels();
    }
    refreshAllDropdowns();
    elEditKey.value = k;
    loadEditorFromKey(k);
    elEditMsg.textContent = `Created '${k}'. Update x/y/z/rho/LHV then click Save.`;
  });

  document.getElementById("btnResetLocal").addEventListener("click", () => {
    if (!confirm("Reset local edits? This removes fuels saved in THIS browser only.")) return;
    resetLocalFuels();
    elEditMsg.textContent = "Local edits cleared. Back to defaults.";
    refreshAllDropdowns();
  });

  elEditKey.addEventListener("change", () => loadEditorFromKey(elEditKey.value));

  function update() {
    const keyA = elFuelA.value;
    const keyB = elFuelB.value;

    const wA_pct = parseFloat(elMassA.value);
    const wA = wA_pct / 100.0;
    const wB_pct = 100 - wA_pct;

    elPillA.textContent = `A: ${wA_pct.toFixed(0)}%`;
    elPillB.textContent = `B: ${wB_pct.toFixed(0)}%`;

    if (!keyA || !keyB || !FUELS[keyA] || !FUELS[keyB]) {
      showWarn("Fuel selection is missing (check filter).");
      return;
    }

    if (keyA === keyB) {
      showWarn("Please choose two different fuels.");
      return;
    }

    // Soft warning for cryogenic methane case (trend only)
    if ((keyA === "LCH4" && ["JetA","HEFA","FT","ATJ"].includes(keyB)) ||
        (keyB === "LCH4" && ["JetA","HEFA","FT","ATJ"].includes(keyA))) {
      showWarn("Note: Liquid methane is cryogenic; blending with Jet fuels is not a practical fuel-handling basis. Use for screening/trends only.");
    } else {
      showWarn("");
    }

    try {
      const fA = FUELS[keyA];
      const fB = FUELS[keyB];

      const blend = blendMass2(fA, fB, wA);
      const customName = elName.value.trim();
      blend.name = customName ? customName : `Blend(${keyA}:${wA_pct.toFixed(0)}mass%, ${keyB}:${wB_pct.toFixed(0)}mass%)`;

      // Bundle 1 calculations
      const mwf = mwFuel(blend);
      const nuO2 = nuO2Stoich(blend);
      const afr_st = afrStoichMass(blend);
      const co2kgkg = co2IntensityKgPerKg(blend);
      const h2okgkg = h2oIntensityKgPerKg(blend);
      const co2gkWh = co2PerKWhth_g(blend);
      const LHVvol = blend.LHV * blend.rho / 1000.0; // MJ/L

      // Bundle 2/3 variables (ensure defined)
      let phi = NaN, lambda = NaN, q_air = NaN;
      let mdot_f = NaN, mdot_a = NaN;
      let hasQ = false;

      const afr_act = parseFloat((elAfrAct.value || "").trim());
      const hasAFRact = Number.isFinite(afr_act) && afr_act > 0;

      if (hasAFRact) {
        phi = afr_st / afr_act;
        lambda = 1.0 / phi;
        q_air = blend.LHV / afr_act; // MJ/kg air

        const qMW = parseFloat((elQthMW.value || "").trim());
        hasQ = Number.isFinite(qMW) && qMW > 0;
        if (hasQ) {
          const Q_MJps = qMW; // 1 MW = 1 MJ/s
          mdot_f = Q_MJps / blend.LHV;     // kg/s
          mdot_a = afr_act * mdot_f;       // kg/s
        }
      }

      // ---- Visual widgets update ----
      gLHV.textContent = fmt(blend.LHV, 2);
      setFill(gLHVFill, blend.LHV, 20, 50);

      gRho.textContent = fmt(blend.rho, 1);
      setFill(gRhoFill, blend.rho, 650, 900);

      gAFRst.textContent = fmt(afr_st, 2);
      setFill(gAFRFill, afr_st, 5, 25);

      gCO2kWh.textContent = fmt(co2gkWh, 1);
      setFill(gCO2kWhFill, co2gkWh, 150, 350);

      bLHVvol.textContent = fmt(LHVvol, 2);
      setFill(bLHVvolFill, LHVvol, 10, 40);

      bCO2kgkg.textContent = fmt(co2kgkg, 3);
      setFill(bCO2Fill, co2kgkg, 1.5, 3.5);

      bH2Okgkg.textContent = fmt(h2okgkg, 3);
      setFill(bH2OFill, h2okgkg, 0.5, 2.0);

      if (hasAFRact){
        gPhi.textContent = fmt(phi, 3);
        setFill(gPhiFill, phi, 0.2, 2.0);

        bQair.textContent = fmt(q_air, 3);
        setFill(bQairFill, q_air, 0.5, 5.0);

        tLambda.textContent = fmt(lambda, 3);
      } else {
        gPhi.textContent = "—"; gPhiFill.style.width = "0%";
        bQair.textContent = "—"; bQairFill.style.width = "0%";
        tLambda.textContent = "—";
      }

      // Compact summary
      tFormula.textContent = `C${fmt(blend.xC,3)}H${fmt(blend.yH,3)}O${fmt(blend.zO,3)}`;
      tMW.textContent = fmt(mwf, 2);
      tNuO2.textContent = fmt(nuO2, 4);

      tMdotF.textContent = (hasAFRact && hasQ) ? fmt(mdot_f, 6) : "—";
      tMdotA.textContent = (hasAFRact && hasQ) ? fmt(mdot_a, 6) : "—";

    } catch (e) {
      showWarn("Computation error: " + (e?.message || e));
    }
  }

  // ---- Live updates
  elFuelA.addEventListener("change", update);
  elFuelB.addEventListener("change", update);
  elMassA.addEventListener("input", update);
  elName.addEventListener("input", update);
  elAfrAct.addEventListener("input", update);
  elQthMW.addEventListener("input", update);
  elFuelSearch.addEventListener("input", () => refreshAllDropdowns());

  // ---- Init
  refreshAllDropdowns();
</script>
</body>
</html>
